name: Social Blast
on:
  push:
    paths:
      - 'src/content/posts/**.md'
      - 'src/content/posts/**.mdx'
    branches:
      - main

jobs:
  publish-to-facebook:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Wait for Site Deployment
        run: |
          echo "Waiting 3 minutes for the website to build and go live..."
          sleep 180  # <--- THIS IS THE FIX (3 minutes)

      - name: Detect and Post Article
        env:
          FB_TOKEN: ${{ secrets.FACEBOOK_PAGE_TOKEN }}
          SITE_URL: "https://jonathanmwaniki.co.ke"
        run: |
          FILE=$(git diff --name-only HEAD~1 HEAD | grep 'src/content/posts/' | head -n 1)

          if [ -z "$FILE" ]; then
            echo "No post file detected. Exiting."
            exit 0
          fi

          # Extract Title
          TITLE=$(grep -m 1 "^title:" "$FILE" | cut -d: -f2- | tr -d '"' | sed 's/^ *//')

          # Construct Link
          FILENAME=$(basename "$FILE")
          SLUG="${FILENAME%.*}"
          LINK="$SITE_URL/posts/$SLUG/"

          echo "Posting: $TITLE ($LINK)"

          # Send to Facebook
          curl -s -X POST "https://graph.facebook.com/v24.0/me/feed" \
            -d "message=New Article: $TITLE" \
            -d "link=$LINK" \
            -d "access_token=$FB_TOKEN"