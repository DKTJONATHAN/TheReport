name: ðŸš€ Auto-Post Latest Blog to X
on:
  schedule:
    - cron: '30 2 * * *' # Runs 30 mins after your sitemap/llms.txt generation
  workflow_dispatch:      # Allows you to test it manually

jobs:
  tweet:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install twitter-api-v2 axios fast-xml-parser

      - name: Fetch Latest Post & Tweet
        env:
          APP_KEY: ${{ secrets.TWITTER_CONSUMER_KEY }}
          APP_SECRET: ${{ secrets.TWITTER_CONSUMER_SECRET }}
          ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
        run: |
          node -e "
          const { TwitterApi } = require('twitter-api-v2');
          const axios = require('axios');
          const { XMLParser } = require('fast-xml-parser');

          const client = new TwitterApi({
            appKey: process.env.APP_KEY,
            appSecret: process.env.APP_SECRET,
            accessToken: process.env.ACCESS_TOKEN,
            accessSecret: process.env.ACCESS_SECRET,
          });

          async function run() {
            try {
              // 1. Fetch the sitemap
              const response = await axios.get('https://www.jonathanmwaniki.co.ke/sitemap-0.xml');
              const parser = new XMLParser();
              const jsonObj = parser.parse(response.data);
              
              // 2. Get the last URL in the list (assuming sitemap is chronological)
              const urls = jsonObj.urlset.url;
              const latestEntry = Array.isArray(urls) ? urls[urls.length - 1] : urls;
              const url = latestEntry.loc;

              // 3. Clean the slug to create a Title
              // Example: .../posts/my-new-article -> My New Article
              const slug = url.split('/').pop();
              const title = slug
                .replace(/-/g, ' ')
                .replace(/\b\w/g, l => l.toUpperCase());

              // 4. Send the Tweet
              const tweetText = \`\${title}\n\n\${url}\`;
              
              console.log('Sending tweet:', tweetText);
              await client.v2.tweet(tweetText);
              console.log('Successfully posted to X!');
            } catch (error) {
              console.error('Workflow failed:', error);
              process.exit(1);
            }
          }
          run();
          "