name: üöÄ Instant Post to X on Publish

on:
  push:
    paths:
      - 'src/content/posts/**.md'
      - 'src/content/posts/**.mdx'
  workflow_dispatch:

jobs:
  tweet:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2 

      - name: Get Changed Post Files
        id: changed-files
        run: |
          # Detects only NEW (A) or MODIFIED (M) files in the posts directory
          FILES=$(git diff --name-only --diff-filter=AM HEAD^ HEAD | grep '^src/content/posts/' || true)
          echo "files=$FILES" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        # We removed axios/jsdom because we now read the local file (safer/faster)
        run: npm install twitter-api-v2

      - name: Detect and Tweet
        if: steps.changed-files.outputs.files != ''
        env:
          APP_KEY: ${{ secrets.TWITTER_CONSUMER_KEY }}
          APP_SECRET: ${{ secrets.TWITTER_CONSUMER_SECRET }}
          ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
        run: |
          node -e "
          const fs = require('fs');
          const { TwitterApi } = require('twitter-api-v2');

          const client = new TwitterApi({
            appKey: process.env.APP_KEY,
            appSecret: process.env.APP_SECRET,
            accessToken: process.env.ACCESS_TOKEN,
            accessSecret: process.env.ACCESS_SECRET,
          });

          async function run() {
            const files = \`${{ steps.changed-files.outputs.files }}\`.split('\n').filter(Boolean);
            
            // 1. Wait for Vercel (Ensure OG Image is ready)
            if (files.length > 0) {
              console.log('‚è≥ Waiting 90s for Vercel deployment to propagate...');
              await new Promise(r => setTimeout(r, 90000));
            }

            for (const file of files) {
              try {
                // 2. Read File Content directly (No scraping needed)
                const content = fs.readFileSync(file, 'utf8');
                
                // 3. Extract Slug
                const slug = file.split('/').pop().replace(/\.mdx?$/, '');
                const url = \`https://www.jonathanmwaniki.co.ke/posts/\${slug}\`;

                // 4. Extract Title (Regex)
                const titleMatch = content.match(/^title:\s*[\"']?(.*?)[\"']?$/m);
                const title = titleMatch ? titleMatch[1] : 'New Article';

                // 5. Extract Tags & Convert to Hashtags
                // Looks for: tags: [News, Tech]
                const tagsMatch = content.match(/^tags:\s*\[(.*?)\]/m);
                let hashtags = '';
                
                if (tagsMatch && tagsMatch[1]) {
                   hashtags = tagsMatch[1]
                    .replace(/['\"]/g, '')       // Remove quotes
                    .split(',')                  // Split by comma
                    .map(t => '#' + t.trim().replace(/\s+/g, '')) // Remove spaces inside tags (e.g. #GlobalNews)
                    .join(' ');
                }

                // 6. Construct Tweet
                const tweetText = \`\${title}\n\n\${hashtags}\n\n\${url}\`;
                
                console.log('üê¶ Tweeting:', tweetText);

                // 7. Send
                await client.v2.tweet(tweetText);
                console.log('‚úÖ Successfully tweeted!');

              } catch (e) {
                console.error(\`‚ùå Error processing \${file}:\`, e.message);
              }
            }
          }
          run();
          "