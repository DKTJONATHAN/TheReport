name: ðŸš€ Auto-Post Latest Blog to X
on:
  schedule:
    - cron: '30 2 * * *' 
  workflow_dispatch:

jobs:
  tweet:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install twitter-api-v2 axios fast-xml-parser

      - name: Fetch Latest Post & Tweet
        env:
          APP_KEY: ${{ secrets.TWITTER_CONSUMER_KEY }}
          APP_SECRET: ${{ secrets.TWITTER_CONSUMER_SECRET }}
          ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
        run: |
          node -e "
          const { TwitterApi } = require('twitter-api-v2');
          const axios = require('axios');
          const { XMLParser } = require('fast-xml-parser');

          const client = new TwitterApi({
            appKey: process.env.APP_KEY,
            appSecret: process.env.APP_SECRET,
            accessToken: process.env.ACCESS_TOKEN,
            accessSecret: process.env.ACCESS_SECRET,
          });

          async function run() {
            try {
              const response = await axios.get('https://www.jonathanmwaniki.co.ke/sitemap-0.xml');
              const parser = new XMLParser();
              const jsonObj = parser.parse(response.data);
              
              // 1. Filter for blog posts specifically
              const urls = jsonObj.urlset.url;
              const postEntries = urls.filter(u => u.loc.includes('/posts/'));
              
              if (postEntries.length === 0) throw new Error('No posts found in sitemap');
              
              const latestEntry = postEntries[postEntries.length - 1];
              const url = latestEntry.loc;

              // 2. Format the Title from the slug
              const cleanUrl = url.endsWith('/') ? url.slice(0, -1) : url;
              const slug = cleanUrl.split('/').pop();
              const title = slug.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

              // 3. Post the Tweet
              const tweetText = \`\${title}\n\n\${url}\`;
              console.log('Posting:', tweetText);
              
              await client.v2.tweet(tweetText);
              console.log('Success!');
            } catch (error) {
              console.error('Error:', error.message);
              process.exit(1);
            }
          }
          run();
          "