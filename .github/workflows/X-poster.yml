name: ðŸš€ Instant Post to X on Publish
on:
  push:
    paths:
      - 'src/content/posts/**'
  workflow_dispatch: 

jobs:
  tweet:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2 

      - name: Get Changed Post Files
        id: changed-files
        run: |
          # Detects only NEW (A) or MODIFIED (M) files in the posts directory
          FILES=$(git diff --name-only --diff-filter=AM HEAD^ HEAD | grep '^src/content/posts/' || true)
          echo "files=$FILES" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install twitter-api-v2 axios jsdom

      - name: Detect and Tweet
        if: steps.changed-files.outputs.files != ''
        env:
          APP_KEY: ${{ secrets.TWITTER_CONSUMER_KEY }}
          APP_SECRET: ${{ secrets.TWITTER_CONSUMER_SECRET }}
          ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
        run: |
          node -e "
          const { TwitterApi } = require('twitter-api-v2');
          const axios = require('axios');
          const { JSDOM } = require('jsdom');

          const client = new TwitterApi({
            appKey: process.env.APP_KEY,
            appSecret: process.env.APP_SECRET,
            accessToken: process.env.ACCESS_TOKEN,
            accessSecret: process.env.ACCESS_SECRET,
          });

          async function run() {
            const files = \`${{ steps.changed-files.outputs.files }}\`.split('\n').filter(Boolean);
            
            for (const file of files) {
              try {
                // 1. Extract slug: src/content/posts/my-post.md -> my-post
                const slug = file.split('/').pop().replace('.md', '');
                const url = \`https://www.jonathanmwaniki.co.ke/posts/\${slug}\`;

                // 2. WAIT for Vercel deployment (90 seconds)
                console.log(\`Waiting 90s for \${slug} to go live on Vercel...\`);
                await new Promise(r => setTimeout(r, 90000));

                // 3. Scrape the live URL
                const pageResponse = await axios.get(url);
                const dom = new JSDOM(pageResponse.data);
                const doc = dom.window.document;
                
                const ogTitle = doc.querySelector('meta[property=\"og:title\"]')?.getAttribute('content');
                const pageTitle = doc.querySelector('title')?.textContent;
                let finalTitle = (ogTitle || pageTitle || 'New Post').split('|')[0].trim();

                // 4. Send Tweet
                const tweetText = \`\${finalTitle}\n\n\${url}\`;
                await client.v2.tweet(tweetText);
                console.log('Successfully tweeted:', finalTitle);

              } catch (e) {
                console.error(\`Error processing \${file}:\`, e.message);
              }
            }
          }
          run();
          "