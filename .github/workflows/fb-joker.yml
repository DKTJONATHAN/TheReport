name: FB Joke Bot (Hourly)

on:
  push:
    paths:
      - '.github/workflows/fb-jokes.yml'
  schedule:
    # Runs at minute 15 of every hour (6 AM - 12 AM EAT)
    - cron: '15 3-21 * * *'
  workflow_dispatch:

jobs:
  post-joke-image:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ImageMagick
        run: sudo apt-get install -y imagemagick jq

      - name: Fetch Joke & Create Image
        env:
          FB_TOKEN: ${{ secrets.FACEBOOK_PAGE_TOKEN }}
        run: |
          # 1. Fetch Joke (Any category, blacklist specific flags only)
          JSON=$(curl -s "https://v2.jokeapi.dev/joke/Any?blacklistFlags=religious,political,racist,sexist&type=single")
          MSG=$(echo $JSON | jq -r '.joke')
          
          # Fallback
          if [ -z "$MSG" ] || [ "$MSG" == "null" ]; then
            MSG="I'm not saying I hate you, but I would unplug your life support to charge my phone."
          fi
          
          # Clean text: remove single quotes and double quotes
          # FIX: Added the missing single quote after the last sed command
          CLEAN_MSG=$(echo "$MSG" | sed "s/'/ /g" | sed 's/"/ /g')
          
          # 2. Generate Image
          COLORS=("purple-blue" "red-orange" "blue-cyan" "pink-purple" "yellow-green" "black-gray")
          RANDOM_COLOR=${COLORS[$RANDOM % ${#COLORS[@]}]}
          
          # Create 1080x1080 square image with text wrapping
          convert -size 1080x1080 gradient:$RANDOM_COLOR \
            -fill white -font DejaVu-Sans-Bold -pointsize 60 -gravity Center \
            -background none -interline-spacing 20 \
            caption:"$CLEAN_MSG" -composite status.jpg

          # 3. Post to Facebook
          echo "Posting to Facebook..."
          curl -s -X POST "https://graph.facebook.com/v24.0/me/photos" \
            -F "source=@status.jpg" \
            -F "message=Mood. ðŸ˜‚ #Humor #DailyJokes" \
            -F "access_token=$FB_TOKEN"