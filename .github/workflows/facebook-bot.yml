name: FB Gossip Bot (Stateless)

on:
  push:
    paths:
      - '.github/workflows/fb-gossip.yml'
  schedule:
    # Runs every 2 hours (odd hours)
    - cron: '15 3,5,7,9,11,13,15,17,19,21 * * *'
  workflow_dispatch:

permissions:
  contents: read # We only read now, no writing = no errors

jobs:
  post-gossip-text:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests google-genai apify-client beautifulsoup4

      - name: Scrape & Post (No Memory)
        env:
          GEMINI_POOL: "${{ secrets.GEMINI_API_KEY }},${{ secrets.GEMINI_API_KEY1 }},${{ secrets.GEMINI_API_KEY2 }},${{ secrets.GEMINI_WRITE_KEY }}"
          APIFY_POOL: "${{ secrets.APIFY_API_TOKEN }},${{ secrets.APIFY_API_TOKEN1 }},${{ secrets.APIFY_API_TOKEN2 }},${{ secrets.APIFY_API_TOKEN3 }},${{ secrets.APIFY_API_TOKEN4 }},${{ secrets.APIFY_API_TOKEN5 }}"
          FB_TOKEN: ${{ secrets.FACEBOOK_PAGE_TOKEN }}
        run: |
          python << 'EOF'
          import os, requests, random, sys
          from google import genai
          from apify_client import ApifyClient
          from bs4 import BeautifulSoup

          # 1. DISCOVERY (KenyaMoja Entertainment)
          print("üîç Checking KenyaMoja Entertainment...")
          try:
              res = requests.get("https://www.kenyamoja.com/entertainment", headers={'User-Agent': 'Mozilla/5.0'}, timeout=15)
              items = BeautifulSoup(res.text, 'html.parser').select('li.news-item')
          except Exception as e:
              print(f"‚ùå Network error: {e}")
              sys.exit(1)

          if not items:
              print("‚ö†Ô∏è No items found.")
              sys.exit(0)

          # 2. SELECT RANDOM STORY (Stateless Mode)
          # We pick one from the Top 5 to ensure variety without memory
          top_stories = items[:5]
          selected_item = random.choice(top_stories)
          
          link = selected_item.select_one('.news-title a')
          if not link: sys.exit(0)
          
          target_url = link['href']
          print(f"üï∑Ô∏è Selected Story: {target_url}")

          # 3. SCRAPE (Apify)
          raw_story = None
          apify_keys = [k.strip() for k in os.environ.get("APIFY_POOL", "").split(",") if k.strip()]
          apify = ApifyClient(random.choice(apify_keys))

          try:
              run = apify.actor("apify/website-content-crawler").call(run_input={"startUrls": [{"url": target_url}], "maxCrawlPages": 1})
              data = list(apify.dataset(run["defaultDatasetId"]).iterate_items())
              if data and len(data[0].get('markdown', '')) > 300:
                  raw_story = data[0]['markdown']
          except Exception as e:
              print(f"‚ùå Scrape failed: {e}")
              sys.exit(1)
          
          if not raw_story:
              print("‚ö†Ô∏è Content too short or empty.")
              sys.exit(0)

          # 4. GENERATE (Gemini - Savage Mode)
          print("ü§ñ Generating Tea...")
          gem_keys = [k.strip() for k in os.environ.get("GEMINI_POOL", "").split(",") if k.strip()]
          gemini = genai.Client(api_key=random.choice(gem_keys))
          
          prompt = f"""ACT AS A SAVAGE NAIROBI GOSSIP COLUMNIST.
          SOURCE: {raw_story[:8000]}
          TASK: Write a 150-word Facebook post.
          
          STYLE: 
          - HOOK: Start with a savage, ironic one-liner.
          - SLANG: Use 'Kanairo', 'Tea', 'Wueh', 'Mambo ni mengi'.
          - TONE: Cynical, gossipy, no filter.
          - NO AI SLOP: No 'tapestry', 'realm', 'vibrant'.
          - END: A spicy question.
          TAGS: #TMReport #Buzz #Trending"""
          
          try:
              res = gemini.models.generate_content(model="gemini-3-flash-preview", contents=prompt)
              gossip_text = res.text.strip().replace("*", "").replace("#", "")
          except Exception as e:
              print(f"‚ùå Gemini Error: {e}")
              sys.exit(1)
          
          # 5. POST (Facebook Feed - Text Post)
          print("üöÄ Posting to Facebook...")
          fb_token = os.environ.get("FB_TOKEN")
          final_msg = f"{gossip_text}\n\n#TMReport #Buzz #Trending"
          
          resp = requests.post(
              "https://graph.facebook.com/v24.0/me/feed",
              data={"message": final_msg, "access_token": fb_token}
          )
          
          if resp.status_code == 200:
              print("‚úÖ Posted successfully!")
          else:
              print(f"‚ùå Facebook API Error: {resp.text}")
              sys.exit(1)
          EOF