name: Facebook Pun Bot (10x Daily)
on:
  schedule:
    # Runs every 2 hours from 6 AM to 12 AM (Kenya Time / EAT)
    - cron: '0 3,5,7,9,11,13,15,17,19,21 * * *'
  workflow_dispatch:

jobs:
  post-facebook:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Tools
        run: sudo apt-get install -y imagemagick jq

      - name: Fetch Pure Pun
        run: |
          # Fetching only puns, allowing adult content (nsfw/explicit removed from blacklist)
          JSON=$(curl -s "https://v2.jokeapi.dev/joke/Pun?blacklistFlags=religious,political,racist,sexist&type=single")
          
          # Extract the pun
          MSG=$(echo $JSON | jq -r '.joke')
          
          # Safety check/Fallback
          if [ -z "$MSG" ] || [ "$MSG" == "null" ]; then 
            MSG="I was wondering why the ball was getting bigger. Then it hit me."
          fi
          
          # Clean quotes that might break ImageMagick commands
          # Also replace em dashes with commas for consistency
          CLEAN_MSG=$(echo "$MSG" | sed "s/'/ /g" | sed 's/"/ /g' | sed 's/â€”/, /g')
          
          echo "MSG=$CLEAN_MSG" >> $GITHUB_ENV

      - name: Generate & Post Image
        env:
          FB_TOKEN: ${{ secrets.FACEBOOK_PAGE_TOKEN }}
        run: |
          # Selecting dynamic vibrant gradients for the background
          COLORS=("purple-blue" "red-orange" "blue-cyan" "pink-purple" "yellow-green" "black-gray" "midnightblue-black")
          RANDOM_COLOR=${COLORS[$RANDOM % ${#COLORS[@]}]}
          
          echo "Generating Image for Facebook with pun: $MSG"

          # 1. Create a 1080x1080 gradient background (Instagram/FB Square size)
          # 2. Overlay the pun text with high contrast
          convert -size 1080x1080 gradient:$RANDOM_COLOR \
            -fill white -font DejaVu-Sans-Bold -pointsize 65 -gravity Center \
            -background none \
            -interline-spacing 10 \
            caption:"$MSG" \
            -composite status.jpg

          # Post to Facebook Page
          curl -s -X POST "https://graph.facebook.com/v24.0/me/photos" \
            -F "source=@status.jpg" \
            -F "message=Pun of the hour ðŸ¤£" \
            -F "access_token=$FB_TOKEN"