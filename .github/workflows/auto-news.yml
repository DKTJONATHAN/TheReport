generate-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ env.DEFAULT_BRANCH }}
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # "google-genai" is the new library required for Gemini 3
          pip install requests google-genai

      - name: Generate article with Gemini
        env:
          GEMINI_WRITE_KEY: ${{ secrets.GEMINI_WRITE_KEY }}
          NEWSAPI_KEY: ${{ secrets.NEWSAPI_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          MANUAL_TOPIC: ${{ inputs.manual_topic }}
        run: |
          python << 'EOF'
          import os, json, datetime, requests, re, random, time
          from google import genai
          from google.genai import types

          # --- 1. CONFIGURATION & TOPIC ---
          date_str = datetime.datetime.utcnow().date().strftime("%Y-%m-%d")
          current_hour_utc = datetime.datetime.utcnow().hour
          
          manual_input = os.environ.get('MANUAL_TOPIC', '').strip().lower()
          if manual_input in ['sports', 'technology', 'business']:
              topic = manual_input
              newsapi_category = {'sports': 'sports', 'technology': 'technology', 'business': 'business'}[topic]
          else:
              if current_hour_utc == 0 or current_hour_utc == 14: topic = 'sports'; newsapi_category = 'sports'
              elif current_hour_utc == 6 or current_hour_utc == 22: topic = 'technology'; newsapi_category = 'technology'
              else: topic = 'business'; newsapi_category = 'business'
          
          print(f"ðŸŽ¯ Topic: {topic} | Category: {newsapi_category}")

          # --- 2. FETCH REAL-TIME NEWS (International) ---
          params = {
              'category': newsapi_category,
              'language': 'en',
              'pageSize': 5,
              'apiKey': os.environ['NEWSAPI_KEY']
          }
          try:
              news_resp = requests.get('https://newsapi.org/v2/top-headlines', params=params, timeout=10)
              news_data = news_resp.json()
          except Exception as e:
              print(f"Error fetching news: {e}")
              exit(0)
          
          if news_data.get('totalResults', 0) == 0:
              print("No news available, skipping")
              exit(0)
          
          # Pick FRESHEST top story
          top_story = min(news_data['articles'], key=lambda x: x['publishedAt'] if x['publishedAt'] else '9999')
          title = top_story['title']
          snippet = (top_story.get('description') or top_story.get('content', ''))[:300]
          source = top_story['source']['name']
          pub_date = top_story['publishedAt']
          
          print(f"ðŸ“º Top story: {title[:80]}... ({source})")

          # --- 3. IMAGE HELPER ---
          def get_real_image(query):
              access_key = os.environ.get("UNSPLASH_ACCESS_KEY")
              fallback = "https://image.pollinations.ai/prompt/minimalist-abstract-3d-render-of-{}-no-humans?width=1200&height=630&nologo=true".format(query.replace(" ", "-"))
              if not access_key:
                  return fallback.format(query)
              url = f"https://api.unsplash.com/photos/random?query={query}&orientation=landscape&client_id={access_key}"
              try:
                  resp = requests.get(url, timeout=10)
                  if resp.status_code == 200:
                      return resp.json()['urls']['regular']
              except: pass
              return fallback.format(query)

          # --- 4. REPORTING-TONE PROMPT ---
          hooks = [
             "Straight reporting: What happened, when, where, who, why.",
             "Key facts first: Timeline of events.",
             "Source-led: What experts/officials said.",
             "Data-driven: Numbers and impacts."
          ]
          selected_hook = random.choice(hooks)

          cat_map = { 'sports':'Sports', 'technology':'Technology', 'business':'Business' }
          display_category = cat_map.get(topic, 'General')

          prompt = f'''STRICT REPORTING MODE for jonathanmwaniki.co.ke.

          NEWS ITEM:
          Title: "{title}"
          Snippet: "{snippet}"
          Source: {source}
          Published: {pub_date}

          TASK: Write FACTUAL news article. NO OPINIONS. NO HYPOTHESIS. NO HALLUCINATIONS.
          - Stick to verifiable facts from snippet + your knowledge of this exact story.
          - Report in neutral, professional journalist tone.
          - Verify/expand only from reputable sources matching this headline.
          - Opening: {selected_hook}

          OUTPUT FORMAT (exact):
          TITLE: [News-style headline, 60 chars]
          DESCRIPTION: [Factual 1-2 sentence summary, 160 chars]
          CATEGORY: [{display_category}]
          TAGS: [3-5 relevant tags]
          IMAGE_KEYWORD: [2-3 words for image]
          BODY:
          [Full article: 1200-1600 words. ## Headers for sections. Cite sources inline.]

          RULES:
          - Facts only. If unknown, say "details unclear".
          - No changing topic. Cover THIS story only.
          - UK English, commas not em-dashes.
          - 5-7 sections: Background, Key Developments, Impacts, Reactions, Next Steps.'''

          # --- 5. GEMINI 3 CALL (New SDK) ---
          client = genai.Client(api_key=os.environ.get("GEMINI_WRITE_KEY"))
          
          # STRICTLY use Gemini 3 Flash Preview
          model_id = "gemini-3-flash-preview"
          
          print(f"ðŸ¤– Generating with {model_id}...")
          
          try:
              response = client.models.generate_content(
                  model=model_id,
                  contents=prompt,
                  config=types.GenerateContentConfig(
                      temperature=0.1
                  )
              )
              full_text = response.text.strip()
          except Exception as e:
              print(f"âŒ Gemini 3 Error: {e}")
              exit(1)

          # --- 6. PARSE ---
          parsed = { "TITLE": title[:60], "DESCRIPTION": snippet[:160], "CATEGORY": "Technology", "TAGS": f"{topic},international,news", "IMAGE_KEYWORD": topic, "BODY": "" }
          current_section = None
          
          for line in full_text.splitlines():
              clean_line = line.strip().replace("**", "")
              if clean_line.startswith("TITLE:"): parsed["TITLE"] = clean_line.replace("TITLE:", "").strip()
              elif clean_line.startswith("DESCRIPTION:"): parsed["DESCRIPTION"] = clean_line.replace("DESCRIPTION:", "").strip()
              elif clean_line.startswith("CATEGORY:"): parsed["CATEGORY"] = clean_line.replace("CATEGORY:", "").strip()
              elif clean_line.startswith("TAGS:"): parsed["TAGS"] = clean_line.replace("TAGS:", "").strip()
              elif clean_line.startswith("IMAGE_KEYWORD:"): parsed["IMAGE_KEYWORD"] = clean_line.replace("IMAGE_KEYWORD:", "").strip()
              elif clean_line.startswith("BODY:"): current_section = "BODY"
              elif current_section == "BODY": parsed["BODY"] += line + "\n"

          # Em-Dash scrubber
          for key in ["TITLE", "DESCRIPTION", "BODY"]:
              text = parsed[key]
              text = text.replace("â€”", ", ").replace("â€“", ", ").replace("--", ", ")
              text = re.sub(r',\s*,', ',', text)
              parsed[key] = text.strip()

          # --- 7. FINAL FILE ---
          image_url = get_real_image(parsed['IMAGE_KEYWORD'])
          slug = re.sub(r'[^a-z0-9-]', '-', parsed["TITLE"].lower())
          slug = re.sub(r'-+', '-', slug).strip('-')
          tag_list = [t.strip() for t in parsed["TAGS"].split(',')]

          final_file = f"""---
          title: "{parsed['TITLE'].replace('"', "'")}"
          description: "{parsed['DESCRIPTION'].replace('"', "'")}"
          date: "{date_str}"
          author: "Jonathan Mwaniki"
          image: "{image_url}"
          imageCaption: "Image for {parsed['IMAGE_KEYWORD']}"
          imageAlt: "{parsed['IMAGE_KEYWORD']}"
          category: "{parsed['CATEGORY']}"
          tags: {json.dumps(tag_list)}
          featured: true
          draft: false
          slug: "{slug}"
          ---

          # {parsed['TITLE']}

          {parsed['BODY']}

          <div class="article-meta">
            <p><strong>Published:</strong> {date_str}</p>
            <p><strong>Author:</strong> Jonathan Mwaniki</p>
            <p><strong>Tags:</strong> {parsed['TAGS']}</p>
            <div class="source-credit">Source story: {source} ({pub_date})</div>
          </div>
          """

          import textwrap
          final_file = textwrap.dedent(final_file).strip()
          out_dir = os.path.join(os.getcwd(), os.environ.get("POSTS_DIR", "src/content/posts"))
          os.makedirs(out_dir, exist_ok=True)
          with open(os.path.join(out_dir, f"{slug}.md"), "w", encoding="utf-8") as f:
              f.write(final_file)
          print(f"âœ… Published: {slug}.md | {len(parsed['BODY'].split())} words")
          EOF

      - name: Commit and push article
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "content: publish ${{ github.run_id }}"
          branch: ${{ env.DEFAULT_BRANCH }}
          file_pattern: ${{ env.POSTS_DIR }}/*.md
          commit_user_name: "Content Bot"
          commit_user_email: "actions@github.com"
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}