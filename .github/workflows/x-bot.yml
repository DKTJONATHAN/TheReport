name: Twitter Pun Bot (4x Daily)
on:
  schedule:
    # 8 AM, 1 PM, 5 PM, 9 PM (Kenya Time / EAT)
    - cron: '0 5,10,14,18 * * *'
  workflow_dispatch:

jobs:
  post-twitter:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      
      - name: Install Deps
        run: pip install tweepy jq

      - name: Fetch Latest Pun
        run: |
          MAX_RETRIES=5
          COUNT=0
          MSG=""
          
          while [ $COUNT -lt $MAX_RETRIES ]; do
             echo "Attempting to fetch a fresh pun..."
             
             # API URL: Focused on Puns, Adult content ALLOWED (nsfw/explicit removed from blacklist)
             # Blacklist still keeps religious, political, racist, and sexist content out to avoid account suspension.
             JSON=$(curl -s "https://v2.jokeapi.dev/joke/Pun?blacklistFlags=religious,political,racist,sexist&type=single&maxLength=280")
             
             TEMP_MSG=$(echo $JSON | jq -r '.joke')

             # Validate length and content
             LEN=${#TEMP_MSG}
             if [ "$TEMP_MSG" != "null" ] && [ $LEN -gt 5 ] && [ $LEN -le 280 ]; then
                echo "✅ Success! Found a pun."
                MSG="$TEMP_MSG"
                break
             else
                echo "❌ Retrying for a better pun ($((COUNT+1))/$MAX_RETRIES)..."
                COUNT=$((COUNT+1))
                sleep 3
             fi
          done

          # Fallback if the API fails
          if [ -z "$MSG" ]; then 
            MSG="I'm reading a book on anti-gravity. It's impossible to put down."
          fi
          
          echo "MSG=$MSG" >> $GITHUB_ENV

      - name: Post to Twitter
        env:
          TW_KEY: ${{ secrets.TWITTER_CONSUMER_KEY }}
          TW_SECRET: ${{ secrets.TWITTER_CONSUMER_SECRET }}
          TW_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TW_SECRET_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
          TWEET_TEXT: ${{ env.MSG }}
        run: |
          cat <<EOF > tweet.py
          import tweepy, os, sys
          try:
              client = tweepy.Client(
                  consumer_key=os.environ['TW_KEY'],
                  consumer_secret=os.environ['TW_SECRET'],
                  access_token=os.environ['TW_TOKEN'],
                  access_token_secret=os.environ['TW_SECRET_TOKEN']
              )
              client.create_tweet(text=os.environ['TWEET_TEXT'])
              print("✅ Pun Tweeted Successfully")
          except Exception as e:
              print(f"❌ Error: {e}")
              sys.exit(1)
          EOF
          python tweet.py