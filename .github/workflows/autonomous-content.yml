      - name: Generate article with Gemini 3 Flash
        id: generate_article
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python << 'EOF'
          import os, json, datetime, random, textwrap, requests, re

          with open("config/super-agent.json", "r", encoding="utf-8") as f:
            cfg = json.load(f)

          high_cpm = cfg["content_strategy"]["content_pillars"]["distribution_rules"]["high_cpm_focus_90_percent"]
          ke_local = cfg["content_strategy"]["content_pillars"]["distribution_rules"]["kenya_local_10_percent"]

          if random.random() < 0.9:
            pillar_spec = random.choice(high_cpm)
          else:
            pillar_spec = random.choice(ke_local)

          pillar_name = pillar_spec["pillar"]
          mission = cfg["mission_statement"]["primary"]
          voice = cfg["CRITICAL_WRITING_RULES"]["VOICE_REQUIREMENTS"]
          article_spec = cfg["content_strategy"]["article_specifications"]
          date_str = datetime.datetime.utcnow().date().strftime("%Y-%m-%d")

          system_prompt = f"""
          You are an autonomous content agent for jonathanmwaniki.co.ke.

          Mission:
          {mission}

          Hard rules:
          - Word count between {article_spec["word_count"]["minimum"]} and {article_spec["word_count"]["maximum"]}, target {article_spec["word_count"]["target"]}.
          - Use tone: {voice["tone"]}.
          - Perspective: {voice["perspective"]}.
          - Sentence rhythm: {voice["sentence_structure"]["rhythm"]}.
          - Signature phrases: {", ".join(voice["signature_phrases"])}.
          - Kenyan context: {json.dumps(voice["kenyan_context"])}.
          - ABSOLUTE NEVER: em dashes, any citation syntax, banned phrases, summary/conclusion sections.

          Pillar: {pillar_name}
          Keywords: {", ".join(pillar_spec.get("keywords", []))}

          Output:
          - Full markdown file starting with YAML frontmatter using ---.
          - Frontmatter fields: title, description, date, author, image, imageCaption, imageAlt, category, tags, featured, draft, slug.
          - date: "{date_str}"
          - author: "Jonathan Mwaniki"
          - featured: true
          - draft: false
          - slug: lowercase-kebab-case, no dates.
          - After frontmatter, first line in body is "# EXACT TITLE".
          - End with a numbered action list and then:
            <div class="article-meta">
              <p><strong>Published:</strong> {date_str}</p>
              <p><strong>Author:</strong> Jonathan Mwaniki</p>
              <p><strong>Tags:</strong> tag1, tag2, tag3, tag4</p>
            </div>
          """

          api_key = os.environ.get("GEMINI_API_KEY")
          if not api_key:
            raise SystemExit("Missing GEMINI_API_KEY")

          url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent"

          payload = {
            "contents": [
              {
                "parts": [
                  {
                    "text": system_prompt
                  }
                ]
              }
            ]
          }

          headers = {
            "x-goog-api-key": api_key,
            "Content-Type": "application/json"
          }

          resp = requests.post(url, headers=headers, data=json.dumps(payload), timeout=120)
          if resp.status_code != 200:
            raise SystemExit(f"Gemini API error {resp.status_code}: {resp.text[:500]}")

          data = resp.json()
          try:
            text = data["candidates"]["content"]["parts"]["text"]
          except Exception:
            raise SystemExit(f"Unexpected Gemini response: {json.dumps(data)[:800]}")

          m = re.search(r'^title:s*"([^"]+)"', text, re.MULTILINE)
          title = m.group(1).strip() if m else "Untitled"

          github_output = os.environ.get("GITHUB_OUTPUT")
          if github_output:
            with open(github_output, "a", encoding="utf-8") as fh:
              fh.write(f"markdown<<EOF
{text}
EOF
")
              fh.write(f"title={title}
")
          EOF