name: Autonomous Real-Time Publisher

on:
  schedule:
    - cron: '0 1 * * *'   # 4 AM EAT: Big World Tech
    - cron: '0 6 * * *'   # 9 AM EAT: Sports (Kenyan, Euro, Athletics)
    - cron: '0 10 * * *'  # 1 PM EAT: Politics (International & African)
    - cron: '0 15 * * *'  # 6 PM EAT: Entertainment & Kenyan Social
  workflow_dispatch:
    inputs:
      manual_topic:
        description: 'What do you want to write about?'
        required: false
        default: ''

permissions:
  contents: write

env:
  DEFAULT_BRANCH: main
  POSTS_DIR: src/content/posts

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ env.DEFAULT_BRANCH }}
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Generate and Humanize Content
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          MANUAL_TOPIC: ${{ github.event.inputs.manual_topic }}
        run: |
          python << 'EOF'
          import os, json, datetime, requests, re, random, time

          date_str = datetime.datetime.utcnow().strftime('%Y-%m-%d')
          current_hour_utc = datetime.datetime.utcnow().hour
          manual_input = os.environ.get('MANUAL_TOPIC', '').strip()

          # 1. TOPIC SELECTION
          if manual_input:
              topic, focus = manual_input, "User defined manual topic."
          elif 0 <= current_hour_utc < 4:
              topic, focus = "Big World Tech", "Cutting edge AI, space wars, and quantum control. Focus on power moves."
          elif 4 <= current_hour_utc < 9:
              topic, focus = "Sports Aggression", "FKF-PL rivalries, Athletics doping scandals, or European football greed."
          elif 9 <= current_hour_utc < 14:
              topic, focus = "Raw Politics", "Corruption, international betrayal, and the reality of African power dynamics."
          else:
              topic, focus = "Culture & Vice", "Kenyan social trends, celebrity collapses, and the unfiltered truth of digital fame."

          def call_gemini(prompt, temperature=0.9):
              api_key = os.environ.get("GEMINI_API_KEY")
              url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key={api_key}"
              payload = {
                  "contents": [{"parts": [{"text": prompt}]}],
                  "generationConfig": {"temperature": temperature, "maxOutputTokens": 8192},
                  "safetySettings": [
                      {"category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE"},
                      {"category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE"},
                      {"category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE"},
                      {"category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE"}
                  ]
              }
              try:
                  resp = requests.post(url, json=payload, timeout=180)
                  return resp.json()["candidates"][0]["content"]["parts"][0]["text"]
              except Exception as e:
                  print(f"Error: {e}")
                  return None

          # 2. GENERATION PASS (The Raw Content)
          raw_prompt = f"""
          Write a 1500-word, high-SEO, fearless article.
          DATE: {date_str}
          TOPIC: {topic}
          FOCUS: {focus}

          STYLE REQUIREMENTS:
          - UNAPOLOGETIC: Do not use safe language. If someone is a fraud, call them a fraud. Use names.
          - VULGARITY: Use strong language if it adds impact. Do not be polite.
          - SEO: Use highly competitive, high-volume keywords in the title and headers.
          - HUMANIZATION: Use sentence fragments. Start sentences with 'But' or 'And'. Use rhetorical questions. Use Kenyan slang where appropriate.
          - NO AI-ISMS: No 'pivotal', 'delve', 'tapestry', 'landscape', or 'complex'.
          - DASH RULE: NO em dashes (â€”). Use commas.

          FORMAT:
          TITLE: [Hard-hitting, SEO-heavy headline]
          DESCRIPTION: [Savage 2-sentence meta summary]
          CATEGORY: [Category]
          TAGS: [tag1, tag2]
          IMAGE_KEYWORD: [Cinematic prompt]
          BODY: [Content]
          """

          raw_content = call_gemini(raw_prompt)

          # 3. VERIFICATION & HUMANIZATION PASS (The Filter)
          humanizer_prompt = f"""
          Review the following article. Rate its 'Human Sound' from 0-100.
          An article sounds like AI if it is too balanced, too helpful, or uses perfect grammar.
          
          HUMAN CRITERIA:
          - Does it sound angry, biased, or passionate? (Good)
          - Does it use short, punchy sentences? (Good)
          - Does it mention specific people and call out their bullshit? (Good)
          - Does it sound like a corporate robot? (Bad - Rewrite)

          IF SCORE < 90: Rewrite the entire article to be more chaotic, human, and visceral.
          Otherwise, return the article exactly as is.

          ARTICLE:
          {raw_content}
          """

          final_text = call_gemini(humanizer_prompt, temperature=1.0)
          if not final_text: final_text = raw_content # Fallback

          # 4. PARSING & ASSEMBLY
          parsed = {"TITLE": "Untitled", "DESCRIPTION": "", "CATEGORY": "News", "TAGS": "news", "IMAGE_KEYWORD": "dark cinematic"}
          for line in final_text.splitlines():
              if line.startswith("TITLE:"): parsed["TITLE"] = line.replace("TITLE:", "").strip()
              elif line.startswith("DESCRIPTION:"): parsed["DESCRIPTION"] = line.replace("DESCRIPTION:", "").strip()
              elif line.startswith("CATEGORY:"): parsed["CATEGORY"] = line.replace("CATEGORY:", "").strip()
              elif line.startswith("TAGS:"): parsed["TAGS"] = line.replace("TAGS:", "").strip()
              elif line.startswith("IMAGE_KEYWORD:"): parsed["IMAGE_KEYWORD"] = line.replace("IMAGE_KEYWORD:", "").strip()

          body_start = final_text.find("BODY:") + 5
          raw_body = final_text[body_start:].strip()

          def scrub(t): return t.replace("\u2014", ", ").replace("\u2013", ", ").replace("--", ", ")
          parsed["BODY"], parsed["TITLE"], parsed["DESCRIPTION"] = scrub(raw_body), scrub(parsed["TITLE"]), scrub(parsed["DESCRIPTION"])

          # 5. IMAGE & FILE WRITE
          img_key = os.environ.get("UNSPLASH_ACCESS_KEY")
          img_url = "https://images.unsplash.com/photo-1523805009345-7448845a9e53"
          if img_key:
              try:
                  s_url = f"https://api.unsplash.com/search/photos?query={parsed['IMAGE_KEYWORD']}&client_id={img_key}&per_page=1"
                  s_res = requests.get(s_url).json()
                  if s_res.get('results'): img_url = s_res['results'][0]['urls']['regular']
              except: pass

          slug = re.sub(r'[^a-z0-9-]', '-', parsed["TITLE"].lower()).strip('-')
          tag_list = [t.strip() for t in parsed["TAGS"].split(',')]

          final_md = f"""---
          title: "{parsed['TITLE'].replace('"', "'")}"
          description: "{parsed['DESCRIPTION'].replace('"', "'")}"
          date: "{date_str}"
          author: "Jonathan Mwaniki"
          image: "{img_url}"
          imageCaption: "Unfiltered: {parsed['IMAGE_KEYWORD']}"
          category: "{parsed['CATEGORY']}"
          tags: {json.dumps(tag_list)}
          featured: true
          draft: false
          slug: "{slug}"
          ---

          {parsed['BODY']}
          """

          out_dir = os.environ.get('POSTS_DIR', 'src/content/posts')
          os.makedirs(out_dir, exist_ok=True)
          with open(f"{out_dir}/{slug}.md", "w", encoding="utf-8") as f:
              f.write(final_md)
          EOF

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "content: human-verified autonomous update [${{ github.run_id }}]"
          branch: main