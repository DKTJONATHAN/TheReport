name: Autonomous Content Publisher

on:
  workflow_dispatch:

permissions:
  contents: write

env:
  DEFAULT_BRANCH: main
  POSTS_DIR: src/content/posts

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ env.DEFAULT_BRANCH }}
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Generate article with Gemini 3 Flash
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python << 'EOF'
          import os, json, datetime, requests

          cfg = {
            "mission_statement": {
              "primary": "Deliver fast, entertaining, and accurate Kenyan and international news, tech, finance, politics, and gossip that exposes untold stories with sharp, fearless commentary and feels like a smart friend breaking it all down."
            },
            "content_strategy": {
              "article_specifications": {
                "word_count": {
                  "minimum": 1000,
                  "maximum": 2000,
                  "target": 1500
                }
              }
            },
            "CRITICAL_WRITING_RULES": {
              "VOICE_REQUIREMENTS": {
                "tone": "angry/passionate Kenyan journalist",
                "perspective": "first-person when relevant ('I walked into...', 'I saw...')",
                "sentence_structure": {
                  "rhythm": "SHORT. Vary length. Keep reader moving."
                },
                "signature_phrases": [
                  ""I could not lie"",
                  ""Let that sink in"",
                  ""Here's the thing"",
                  ""Think about that"",
                  ""When you combine X + Y + Z"",
                  ""Here's what needs to happen"",
                  ""Kenyans need to demand"",
                  ""Let me be clear""
                ],
                "kenyan_context": {
                  "use_sheng": "acceptable if natural",
                  "local_references": "required for Kenya-focused content",
                  "global_framing": "connect Kenya stories to global trends"
                },
                "formatting_emphasis": {
                  "bold_numbers": True,
                  "examples": ["**Â£390 million**", "**144 billion shillings**"],
                  "direct_questions": "ask reader directly",
                  "call_to_action": "strong ending with numbered action lists"
                }
              }
            },
            "EXACT_ARTICLE_FORMAT": {
              "frontmatter_template": {
                "delimiter": "---",
                "format": "YAML",
                "exact_structure": "---
"
                  "title: "EXACT TITLE USER PROVIDED OR GENERATED"
"
                  "description: "First 2 lines of article or 150 char SEO description"
"
                  "date: "YYYY-MM-DD"
"
                  "author: "Jonathan Mwaniki"
"
                  "image: "https://images.unsplash.com/photo-xxxxx?w=1200"
"
                  "imageCaption: "One descriptive sentence about the image"
"
                  "imageAlt: "SEO keywords describing image for accessibility"
"
                  "category: "tech"
"
                  "tags: ["keyword1", "keyword2", "keyword3", "keyword4"]
"
                  "featured: true
"
                  "draft: false
"
                  "slug: "lowercase-kebab-case-no-dates"
"
                  "---"
              },
              "article_body_structure": {
                "ending": {
                  "format": "<div class="article-meta">
"
                            "  <p><strong>Published:</strong> YYYY-MM-DD</p>
"
                            "  <p><strong>Author:</strong> Jonathan Mwaniki</p>
"
                            "  <p><strong>Tags:</strong> tag1, tag2, tag3, tag4</p>
"
                            "</div>"
                }
              }
            }
          }

          mission = cfg["mission_statement"]["primary"]
          voice = cfg["CRITICAL_WRITING_RULES"]["VOICE_REQUIREMENTS"]
          article_spec = cfg["content_strategy"]["article_specifications"]
          date_str = datetime.datetime.utcnow().date().strftime("%Y-%m-%d")

          system_prompt = f"""
          You are an autonomous content agent for jonathanmwaniki.co.ke.

          Mission:
          {mission}

          Hard rules:
          - Word count between {article_spec["word_count"]["minimum"]} and {article_spec["word_count"]["maximum"]}, target {article_spec["word_count"]["target"]}.
          - Use tone: {voice["tone"]}.
          - Perspective: {voice["perspective"]}.
          - Sentence rhythm: {voice["sentence_structure"]["rhythm"]}.
          - Signature phrases: {", ".join(voice["signature_phrases"])}.
          - Kenyan context: {json.dumps(voice["kenyan_context"])}.
          - ABSOLUTE NEVER: em dashes, any citation syntax, banned phrases, summary/conclusion sections.

          Output:
          - Full markdown file starting with YAML frontmatter using ---.
          - Frontmatter fields: title, description, date, author, image, imageCaption, imageAlt, category, tags, featured, draft, slug.
          - date field must be "{date_str}".
          - author must be "Jonathan Mwaniki".
          - featured: true, draft: false.
          - After frontmatter, first line in body is "# EXACT TITLE" (replace with real title).
          - End with a numbered action list and then:
            <div class="article-meta">
              <p><strong>Published:</strong> {date_str}</p>
              <p><strong>Author:</strong> Jonathan Mwaniki</p>
              <p><strong>Tags:</strong> tag1, tag2, tag3, tag4</p>
            </div>
          """

          api_key = os.environ.get("GEMINI_API_KEY")
          if not api_key:
            raise SystemExit("Missing GEMINI_API_KEY")

          url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent"

          payload = {
            "contents": [
              {
                "parts": [
                  {
                    "text": system_prompt
                  }
                ]
              }
            ]
          }

          headers = {
            "x-goog-api-key": api_key,
            "Content-Type": "application/json"
          }

          resp = requests.post(url, headers=headers, data=json.dumps(payload), timeout=120)
          if resp.status_code != 200:
            raise SystemExit(f"Gemini API error {resp.status_code}: {resp.text[:500]}")

          data = resp.json()
          try:
            text = data["candidates"][0]["content"]["parts"][0]["text"]
          except Exception:
            raise SystemExit(f"Unexpected Gemini response: {json.dumps(data)[:800]}")

          out_dir = os.path.join(os.getcwd(), os.environ.get("POSTS_DIR", "src/content/posts"))
          os.makedirs(out_dir, exist_ok=True)
          out_path = os.path.join(out_dir, "test-article.md")
          with open(out_path, "w", encoding="utf-8") as f:
            f.write(text)

          print(f"Article written to {out_path}")
          EOF

      - name: Commit and push article
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "content: publish article test-article"
          branch: ${{ env.DEFAULT_BRANCH }}
          file_pattern: ${{ env.POSTS_DIR }}/test-article.md
          commit_user_name: "Content Bot"
          commit_user_email: "actions@github.com"
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}