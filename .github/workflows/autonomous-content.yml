name: Autonomous Real-Time Publisher

on:
  schedule:
    - cron: '0 1 * * *'
    - cron: '0 6 * * *'
    - cron: '0 10 * * *'
    - cron: '0 15 * * *'
  workflow_dispatch:
    inputs:
      manual_topic:
        description: 'What do you want to write about?'
        required: false
        default: ''

permissions:
  contents: write

env:
  DEFAULT_BRANCH: main
  POSTS_DIR: src/content/posts

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ env.DEFAULT_BRANCH }}
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Generate and Humanize Content
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          MANUAL_TOPIC: ${{ github.event.inputs.manual_topic }}
        run: |
          python << 'EOF'
          import os, json, datetime, requests, re, random, time

          date_str = datetime.datetime.utcnow().strftime('%Y-%m-%d')
          current_hour_utc = datetime.datetime.utcnow().hour
          manual_input = os.environ.get('MANUAL_TOPIC', '').strip()

          # 1. TOPIC LOGIC
          if manual_input:
              topic, focus = manual_input, "User defined manual topic."
          elif 0 <= current_hour_utc < 4:
              topic, focus = "Big World Tech", "Power moves in AI and global tech hegemony. Dark side of Silicon Valley."
          elif 4 <= current_hour_utc < 9:
              topic, focus = "Sports Aggression", "FKF-PL rivalries, corruption in Athletics, and the greed of Euro football."
          elif 9 <= current_hour_utc < 14:
              topic, focus = "Raw African Politics", "Corruption, power shifts, and the real cost of leadership in Kenya and beyond."
          else:
              topic, focus = "Social & Celebrity Vice", "Kenyan social trends, the rot in digital culture, and celebrity vanity."

          def call_gemini(prompt, temperature=1.0):
              api_key = os.environ.get("GEMINI_API_KEY")
              # Using the requested Gemini 3 Flash Preview
              url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key={api_key}"
              payload = {
                  "contents": [{"parts": [{"text": prompt}]}],
                  "generationConfig": {"temperature": temperature, "maxOutputTokens": 8192},
                  "safetySettings": [
                      {"category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE"},
                      {"category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE"},
                      {"category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE"},
                      {"category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE"}
                  ]
              }
              try:
                  resp = requests.post(url, json=payload, timeout=240)
                  res_data = resp.json()
                  if "candidates" in res_data and res_data["candidates"][0]["content"]["parts"]:
                      return res_data["candidates"][0]["content"]["parts"][0]["text"]
                  else:
                      # Check if safety filters blocked it
                      print(f"API returned no candidates. Likely safety block. Response: {res_data}")
                      return None
              except Exception as e:
                  print(f"Request Error: {e}")
                  return None

          # 2. THE GENERATION PASS (Raw & Fearless)
          raw_prompt = f"""
          Write a 1500-word, high-SEO, fearless, and unapologetic article for jonathanmwaniki.co.ke.
          DATE: {date_str}
          TOPIC: {topic} | FOCUS: {focus}

          CRITICAL STYLE RULES:
          - BOLD & FEARLESS: Do not use safe language. If someone is a failure, say it. Mention names.
          - UNFILTERED: Use strong language or vulgarity if it adds human impact.
          - NO AI-ISMS: Never use 'pivotal', 'tapestry', 'delve', or 'landscape'.
          - DASH RULE: Use NO em dashes (â€”). Use commas.
          - HUMANIZATION: Use sentence fragments, Sheng (Kenyan slang), and rhetorical anger.

          OUTPUT FORMAT:
          TITLE: [Savage Keyword-Rich Headline]
          DESCRIPTION: [Savage SEO Summary]
          CATEGORY: [Sports/Technology/Politics/Social]
          TAGS: [tag1, tag2]
          IMAGE_KEYWORD: [Cinematic cinematic prompt]
          BODY: [Full article]
          """

          raw_content = call_gemini(raw_prompt, temperature=0.9)
          
          # 3. THE HUMANIZER & AI-DETECTION BYPASS
          if raw_content:
              humanizer_prompt = f"""
              The following article was written by an AI. It sounds too structured. 
              REWRITE it to sound 100% human. 
              HUMANIZATION TACTICS:
              - Add personal anecdotes or 'I heard' stories.
              - Use conversational fillers (Look, anyway, the thing is).
              - Be biased, aggressive, and opinionated.
              - Use Kenyan slang (Sheng) naturally.
              - BREAK the rules of grammar for emphasis.
              
              IF THE RESULT SOUNDS LIKE AI, YOU FAIL.
              
              ARTICLE:
              {raw_content}
              """
              final_text = call_gemini(humanizer_prompt, temperature=1.0)
          else:
              final_text = None

          if not final_text:
              print("Workflow failed: Gemini refused to generate content.")
              exit(1)

          # 4. PARSING & SCRUBBING
          parsed = {"TITLE": "New Post", "DESCRIPTION": "", "CATEGORY": "Opinion", "TAGS": "news", "IMAGE_KEYWORD": "Nairobi night"}
          for line in final_text.splitlines():
              if line.startswith("TITLE:"): parsed["TITLE"] = line.replace("TITLE:", "").strip()
              elif line.startswith("DESCRIPTION:"): parsed["DESCRIPTION"] = line.replace("DESCRIPTION:", "").strip()
              elif line.startswith("CATEGORY:"): parsed["CATEGORY"] = line.replace("CATEGORY:", "").strip()
              elif line.startswith("TAGS:"): parsed["TAGS"] = line.replace("TAGS:", "").strip()
              elif line.startswith("IMAGE_KEYWORD:"): parsed["IMAGE_KEYWORD"] = line.replace("IMAGE_KEYWORD:", "").strip()

          body_start = final_text.find("BODY:") + 5
          raw_body = final_text[body_start:].strip() if "BODY:" in final_text else final_text

          def scrub(t): return t.replace("\u2014", ", ").replace("\u2013", ", ").replace("--", ", ")
          body = scrub(raw_body)
          title = scrub(parsed["TITLE"])

          # 5. IMAGE & FILE WRITE
          img_key = os.environ.get("UNSPLASH_ACCESS_KEY")
          img_url = "https://images.unsplash.com/photo-1523805009345-7448845a9e53"
          if img_key:
              try:
                  s_url = f"https://api.unsplash.com/search/photos?query={parsed['IMAGE_KEYWORD']}&client_id={img_key}&per_page=1"
                  s_res = requests.get(s_url).json()
                  if s_res.get('results'): img_url = s_res['results'][0]['urls']['regular']
              except: pass

          slug = re.sub(r'[^a-z0-9-]', '-', title.lower()).strip('-')
          tag_list = [t.strip() for t in parsed["TAGS"].split(',')]

          final_md = f"""---
          title: "{title}"
          description: "{parsed['DESCRIPTION']}"
          date: "{date_str}"
          author: "Jonathan Mwaniki"
          image: "{img_url}"
          category: "{parsed['CATEGORY']}"
          tags: {json.dumps(tag_list)}
          slug: "{slug}"
          ---

          {body}
          """

          out_dir = os.environ.get('POSTS_DIR', 'src/content/posts')
          os.makedirs(out_dir, exist_ok=True)
          with open(f"{out_dir}/{slug}.md", "w", encoding="utf-8") as f:
              f.write(final_md)
          EOF

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "content: fearless AI-humanized update [${{ github.run_id }}]"
          branch: main