name: Autonomous Content Publisher

on:
  schedule:
    - cron: '0 1 * * *'   # 4AM EAT (1:00 UTC)
    - cron: '0 5 * * *'   # 8AM EAT (5:00 UTC)
    - cron: '0 10 * * *'  # 1PM EAT (10:00 UTC)
    - cron: '0 12 * * *'  # 3PM EAT (12:00 UTC)
  workflow_dispatch:

permissions:
  contents: write

env:
  DEFAULT_BRANCH: main
  POSTS_DIR: src/content/posts

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        topic: [tech, finance, international-politics, kenyan-social]
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ env.DEFAULT_BRANCH }}
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Generate article with Gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TOPIC: ${{ matrix.topic }}
        run: |
          python << 'EOF'
          import os, json, datetime, requests, re, random

          date_str = datetime.datetime.utcnow().date().strftime("%Y-%m-%d")
          topic = os.environ.get('TOPIC', 'tech')

          # --- 1. DYNAMIC HOOK GENERATOR (Prevents "I was sitting at..." fatigue) ---
          hooks = [
             "A Direct Question: Start immediately with a hard-hitting question to the reader.",
             "A Shocking Statistic: Start with a number that makes no sense and explain it.",
             "A Cynical Observation: Start by mocking a common belief or statement.",
             "A Direct Attack: Start by calling out a specific group (e.g., 'The regulators are lying to you').",
             "A 'Scene from the Future': Start by describing a dystopian or utopian scenario as if it's already here."
          ]
          selected_hook = random.choice(hooks)

          # --- 2. TOPIC-SPECIFIC LOGIC ---
          if topic == 'tech':
              # STRICT GLOBAL ONLY for Tech
              focus_instruction = """
              IMPORTANT: Focus ONLY on GLOBAL EMERGING TECHNOLOGY.
              *** STRICT GEOGRAPHIC LOCK ***
              - DO NOT write about Kenya, Safaricom, M-PESA, or local startups.
              - DO NOT mention Kenyan politics or local regulations.
              - FOCUS ON: AI Agents, Quantum Computing, Space Race (SpaceX/China), Biotech, Semiconductors, Robotics, or Cyber-warfare between superpowers.
              """
              angle_instruction = "Find a global tech breakthrough that feels dangerous or revolutionary."
              
          else:
              # ORIGINAL MIX for Finance, Politics, Social
              focus_instruction = """
              IMPORTANT: Focus on '{topic}' with a mix of Kenyan and Global context.
              
              *** ANTI-REPETITION RULES (STRICT) ***
              - DO NOT write about Starlink vs Safaricom.
              - DO NOT write about IMF/World Bank loans unless the shilling crashed TODAY.
              - DO NOT write generic "corruption is bad" articles—find a SPECIFIC new scandal or event.
              """
              
              angles = [
                 "an ignored scandal",
                 "a rising underdog story",
                 "a policy affecting the common mwananchi",
                 "a controversial opinion on a new event"
              ]
              angle_instruction = f"TODAY'S ANGLE: Find a story about {random.choice(angles)}."

          # --- 3. CONSTRUCT THE PROMPT ---
          spec_text = f"""
          You are an autonomous content agent for jonathanmwaniki.co.ke.

          {focus_instruction}
          {angle_instruction}

          OPENING STRATEGY (CRITICAL):
          - **{selected_hook}**
          - **ABSOLUTE BAN:** DO NOT start with "I was sitting at...", "I walked into...", or "I saw...". Start directly with the concept/anger/fact.

          HIGH-LEVEL MISSION:
          Deliver fast, entertaining, and accurate news. Dig for UNTOLD stories.

          VOICE AND STYLE:
          - Tone: angry/passionate Kenyan journalist (even for global stories, keep the "voice" African/Kenyan, e.g., "These Silicon Valley guys think they own the future...").
          - Perspective: first-person.
          - Signature phrases: "I could not lie", "Let that sink in", "Here's the thing".

          HARD RULES:
          - No em dashes (—).
          - No academic jargon ("delve", "tapestry").
          - No citation syntax like [1].
          - No intro/outro labels.

          *** CRITICAL OUTPUT FORMAT ***
          Line 1: A unique, SEO-optimized, lowercase-kebab-case slug (e.g., nairobi-drainage-scandal-exposed).
          Line 2: The start of the YAML frontmatter (---).
          Line 3+: The rest of the article content.

          1) YAML FRONTMATTER (starts on Line 2):
          ---
          title: "Your punchy title here"
          description: "Hook description"
          date: "{date_str}"
          author: "Jonathan Mwaniki"
          image: "https://images.unsplash.com/photo-xxxxx?w=1200"
          imageCaption: "Caption"
          imageAlt: "Alt text"
          category: "{topic}"
          tags: ["tag1", "tag2"]
          featured: true
          draft: false
          ---

          2) BODY STRUCTURE:
          # EXACT TITLE
          (Content follows...)
          
          <div class="article-meta">
            <p><strong>Published:</strong> {date_str}</p>
            <p><strong>Author:</strong> Jonathan Mwaniki</p>
            <p><strong>Tags:</strong> tag1, tag2</p>
          </div>
          """

          api_key = os.environ.get("GEMINI_API_KEY")
          if not api_key:
            raise SystemExit("Missing GEMINI_API_KEY")

          url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent"

          payload = {
            "contents": [{ "parts": [{ "text": spec_text }] }]
          }

          headers = {
            "x-goog-api-key": api_key,
            "Content-Type": "application/json"
          }

          resp = requests.post(url, headers=headers, data=json.dumps(payload), timeout=120)
          if resp.status_code != 200:
            raise SystemExit(f"Gemini API error {resp.status_code}: {resp.text[:500]}")

          data = resp.json()
          try:
            full_text = data["candidates"][0]["content"]["parts"][0]["text"].strip()
          except Exception:
            raise SystemExit(f"Unexpected Gemini response: {json.dumps(data)[:800]}")

          # --- 4. PARSE SLUG AND CONTENT ---
          lines = full_text.split('\n', 1)
          if len(lines) < 2:
             raw_slug = f"{topic}-story-{date_str}"
             content = full_text
          else:
             raw_slug = lines[0].strip()
             content = lines[1].strip()

          # Sanitize slug
          slug = re.sub(r'[^a-z0-9-]', '', raw_slug.lower())
          if not slug: slug = f"{topic}-daily-{date_str}"

          out_dir = os.path.join(os.getcwd(), os.environ.get("POSTS_DIR", "src/content/posts"))
          os.makedirs(out_dir, exist_ok=True)
          
          out_filename = f"{slug}.md"
          out_path = os.path.join(out_dir, out_filename)
          
          with open(out_path, "w", encoding="utf-8") as f:
            f.write(content)

          print(f"Article written to {out_path}")
          EOF

      - name: Commit and push article
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "content: publish ${{ matrix.topic }} daily article (${{ github.run_id }})"
          branch: ${{ env.DEFAULT_BRANCH }}
          file_pattern: ${{ env.POSTS_DIR }}/*.md
          commit_user_name: "Content Bot"
          commit_user_email: "actions@github.com"
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN }}