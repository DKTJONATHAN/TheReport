name: Autonomous Content Publisher

on:
  schedule:
    - cron: '0 1 * * *'   # 4AM EAT (Tech)
    - cron: '0 5 * * *'   # 8AM EAT (Finance)
    - cron: '0 10 * * *'  # 1PM EAT (Politics)
    - cron: '0 12 * * *'  # 3PM EAT (Social)
  workflow_dispatch:
    inputs:
      manual_topic:
        description: 'Force a topic (optional)'
        required: false
        default: ''

permissions:
  contents: write

env:
  DEFAULT_BRANCH: main
  POSTS_DIR: src/content/posts

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ env.DEFAULT_BRANCH }}
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Generate article with Gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          MANUAL_TOPIC: ${{ inputs.manual_topic }}
        run: |
          python << 'EOF'
          import os, json, datetime, requests, re, random, time

          # --- 1. CONFIGURATION & TOPIC ---
          date_str = datetime.datetime.utcnow().date().strftime("%Y-%m-%d")
          current_hour_utc = datetime.datetime.utcnow().hour
          
          manual_input = os.environ.get('MANUAL_TOPIC', '').strip()
          if manual_input:
              topic = manual_input
          else:
              if current_hour_utc < 3: topic = 'emerging-tech'
              elif current_hour_utc < 8: topic = 'global-finance'
              elif current_hour_utc < 11: topic = 'world-politics'  
              else: topic = 'kenya-news'
          
          print(f"üéØ Selected Topic: {topic}")

          # --- 2. ENHANCED IMAGE HELPER ---
          def get_best_image(title, description, image_keyword, category):
              """
              Intelligently search Unsplash with multiple strategies
              """
              access_key = os.environ.get("UNSPLASH_ACCESS_KEY")
              if not access_key:
                  print("‚ö†Ô∏è No Unsplash key found")
                  return None
              
              # Build search queries in order of specificity
              search_queries = []
              
              # 1. Primary: Use the explicit IMAGE_KEYWORD
              if image_keyword:
                  search_queries.append(image_keyword)
              
              # 2. Extract key entities from title (remove common words)
              title_words = re.sub(r'[^ws]', '', title.lower()).split()
              stop_words = {'the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by', 'from', 'as', 'is', 'was', 'are', 'been', 'be', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'should', 'could', 'may', 'might', 'can', 'how', 'what', 'when', 'where', 'why', 'who'}
              key_words = [w for w in title_words if w not in stop_words and len(w) > 3]
              
              if len(key_words) >= 2:
                  search_queries.append(' '.join(key_words[:3]))
              
              # 3. Fallback to category-specific visuals
              category_visuals = {
                  'Technology': 'modern technology abstract',
                  'Business': 'business professional office',
                  'Finance': 'financial data analytics',
                  'Politics': 'government politics building',
                  'Entertainment': 'entertainment media stage',
                  'Sports': 'sports competition athlete',
                  'Education': 'education learning books',
                  'Opinion': 'debate discussion opinion'
              }
              if category in category_visuals:
                  search_queries.append(category_visuals[category])
              
              # Try each query with retry logic
              for query_idx, query in enumerate(search_queries):
                  print(f"üîç Image search attempt {query_idx + 1}: '{query}'")
                  
                  for attempt in range(3):
                      try:
                          url = f"https://api.unsplash.com/photos/random"
                          params = {
                              'query': query,
                              'orientation': 'landscape',
                              'content_filter': 'high',
                              'client_id': access_key
                          }
                          
                          resp = requests.get(url, params=params, timeout=15)
                          
                          if resp.status_code == 200:
                              data = resp.json()
                              image_url = data['urls']['regular']
                              alt_description = data.get('alt_description', query)
                              print(f"‚úÖ Found image: {alt_description[:50]}...")
                              return {
                                  'url': image_url,
                                  'alt': alt_description,
                                  'query_used': query
                              }
                          elif resp.status_code == 403:
                              print(f"‚ö†Ô∏è Rate limit hit, waiting...")
                              time.sleep(5)
                          else:
                              print(f"‚ö†Ô∏è Status {resp.status_code} for '{query}'")
                              break
                              
                      except Exception as e:
                          print(f"‚ö†Ô∏è Request error: {e}")
                          time.sleep(2)
                  
                  time.sleep(1)  # Brief pause between different queries
              
              print("‚ùå All Unsplash queries exhausted")
              return None

          # --- 3. DYNAMIC PROMPTS (ANTI-GEOPOLITICAL) ---
          hooks = [
             "A Direct Question: Start immediately with a hard-hitting analytical question.",
             "A Shocking Statistic: Start with a complex figure and explain its deeper meaning.",
             "A Cynical Observation: Start by critically challenging a common global belief.",
             "A Bold Critique: Start by identifying a specific group or policy and analyzing its failure."
          ]
          selected_hook = random.choice(hooks)

          # FIXED: Topic-specific prompts that AVOID "geopolitical"
          topic_configs = {
              'emerging-tech': {
                  'focus': "Latest breakthrough in AI, quantum computing, space tech, or robotics. NO Kenya mentions.",
                  'angle': "The hidden risks behind the hype."
              },
              'global-finance': {
                  'focus': "Corporate mergers, market crashes, billionaire moves, or crypto scandals. NO generic IMF stories.",
                  'angle': "Who really wins when markets move."
              },
              'world-politics': {
                  'focus': "International power struggles, elections, diplomatic crises, or military tensions.",
                  'angle': "The real winners and losers behind closed doors."
              },
              'kenya-news': {
                  'focus': "Kenyan business deals, political scandals, entertainment drama, or social movements.",
                  'angle': "What they're not telling you about the real story."
              }
          }

          config = topic_configs.get(topic, topic_configs['kenya-news'])
          focus = config['focus']
          angle = config['angle']

          # --- 4. CONSTRUCT PROMPT (ENHANCED IMAGE KEYWORD REQUEST) ---
          spec_text = f"""
          You are an autonomous content agent for jonathanmwaniki.co.ke.
          TASK: Write a news article about: {focus}
          ANGLE: {angle}
          OPENING: {selected_hook}
          
          *** STRICT OUTPUT FORMAT ***
          TITLE: [Insert punchy title]
          DESCRIPTION: [Insert 2-sentence description]
          CATEGORY: [One of: Business, Sports, Politics, Entertainment, Technology, Education, Opinion]
          TAGS: [tag1, tag2, tag3]
          IMAGE_KEYWORD: [Provide a SPECIFIC, VISUAL search term - be descriptive and concrete. Examples: "quantum computer chip closeup", "wall street trading floor", "satellite orbiting earth", "ai robot hand typing". Avoid generic terms like "technology" or "business".]
          BODY:
          [Write the full 1500-word article here using ## Headers. NO Title at start.]
          
          *** CONTENT RULES ***
          - 6 Distinct Sections (250 words each).
          - USE COMMAS INSTEAD OF EM-DASHES (‚Äî).
          - Go deep. No fluff.
          - NO repetitive analysis patterns. Vary your approach.
          - For IMAGE_KEYWORD: Think about what VISUAL would best represent this story photographically.
          """

          # --- 5. CALL GEMINI (UPDATED: Gemini 3 Flash Preview) ---
          api_key = os.environ.get("GEMINI_API_KEY")
          if not api_key: raise SystemExit("Missing GEMINI_API_KEY")

          # We use the v1beta endpoint for the preview model
          url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key={api_key}"
          headers = { "Content-Type": "application/json" }
          
          # Safety settings to allow geopolitical and critical discussion
          safety_settings = [
              {"category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE"},
              {"category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE"},
              {"category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE"},
              {"category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE"}
          ]

          payload = {
              "contents": [{ "parts": [{ "text": spec_text }] }],
              "safetySettings": safety_settings
          }

          max_retries = 5
          full_text = ""
          
          for attempt in range(max_retries):
              try:
                  resp = requests.post(url, headers=headers, json=payload, timeout=160)
                  if resp.status_code == 200:
                      result = resp.json()
                      if "candidates" in result and result["candidates"][0]["content"]["parts"]:
                          full_text = result["candidates"][0]["content"]["parts"][0]["text"]
                          break
                      else:
                          print(f"‚ö†Ô∏è Attempt {attempt+1}: Content was filtered by safety layer.")
                  else:
                      print(f"‚ùå Attempt {attempt+1}: Error {resp.status_code} - {resp.text[:400]}")
                  
                  time.sleep(30)
              except Exception as e:
                  print(f"‚ö†Ô∏è Network/Request Error: {e}")
                  time.sleep(30)

          if not full_text: 
              raise SystemExit("Failed to get content from Gemini.")

          # --- 6. PARSE & SCRUB ---
          parsed = { "TITLE": f"Daily {topic.replace('-', ' ').title()}", "DESCRIPTION": "Latest update.", "CATEGORY": "Opinion", "TAGS": "news", "IMAGE_KEYWORD": topic, "BODY": "" }
          current_section = None
          
          for line in full_text.splitlines():
              clean_line = line.strip().replace("**", "")
              if clean_line.startswith("TITLE:"): parsed["TITLE"] = clean_line.replace("TITLE:", "").strip()
              elif clean_line.startswith("DESCRIPTION:"): parsed["DESCRIPTION"] = clean_line.replace("DESCRIPTION:", "").strip()
              elif clean_line.startswith("CATEGORY:"): parsed["CATEGORY"] = clean_line.replace("CATEGORY:", "").strip()
              elif clean_line.startswith("TAGS:"): parsed["TAGS"] = clean_line.replace("TAGS:", "").strip()
              elif clean_line.startswith("IMAGE_KEYWORD:"): parsed["IMAGE_KEYWORD"] = clean_line.replace("IMAGE_KEYWORD:", "").strip()
              elif clean_line.startswith("BODY:"): current_section = "BODY"
              elif current_section == "BODY": parsed["BODY"] += line + "
"

          # üßπ Em-Dash Scrubber
          for key in ["TITLE", "DESCRIPTION", "BODY"]:
              text = parsed[key]
              text = text.replace("‚Äî", ", ").replace("‚Äì", ", ").replace("--", ", ")
              text = re.sub(r',s*,', ',', text)
              parsed[key] = text.strip()

          # --- 7. GET BEST MATCHING IMAGE (NO FALLBACK) ---
          print(f"üñºÔ∏è Searching for image...")
          image_result = get_best_image(
              title=parsed['TITLE'],
              description=parsed['DESCRIPTION'],
              image_keyword=parsed['IMAGE_KEYWORD'],
              category=parsed['CATEGORY']
          )
          
          if not image_result:
              raise SystemExit("‚ùå Failed to find appropriate image. Aborting to prevent generic fallback.")
          
          image_url = image_result['url']
          image_alt = image_result['alt']
          image_caption = f"Photo: {image_alt}"
          
          print(f"‚úÖ Using image from query: '{image_result['query_used']}'")

          # --- 8. ASSEMBLE FINAL FILE ---
          slug = re.sub(r'[^a-z0-9-]', '-', parsed["TITLE"].lower())
          slug = re.sub(r'-+', '-', slug).strip('-')
          tag_list = [t.strip() for t in parsed["TAGS"].split(',')]

          final_file = f"""---
          title: "{parsed['TITLE'].replace('"', "'")}"
          description: "{parsed['DESCRIPTION'].replace('"', "'")}"
          date: "{date_str}"
          author: "Jonathan Mwaniki"
          image: "{image_url}"
          imageCaption: "{image_caption}"
          imageAlt: "{image_alt}"
          category: "{parsed['CATEGORY']}"
          tags: {json.dumps(tag_list)}
          featured: true
          draft: false
          slug: "{slug}"
          ---

          # {parsed['TITLE']}

          {parsed['BODY']}

          <div class="article-meta">
            <p><strong>Published:</strong> {date_str}</p>
            <p><strong>Author:</strong> Jonathan Mwaniki</p>
            <p><strong>Tags:</strong> {parsed['TAGS']}</p>
          </div>
          """

          import textwrap
          final_file = textwrap.dedent(final_file).strip()
          out_dir = os.path.join(os.getcwd(), os.environ.get("POSTS_DIR", "src/content/posts"))
          os.makedirs(out_dir, exist_ok=True)
          with open(os.path.join(out_dir, f"{slug}.md"), "w", encoding="utf-8") as f:
              f.write(final_file)
          print(f"‚úÖ Success! Created {slug}.md")
          EOF

      - name: Commit and push article
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "content: publish daily article (${{ github.run_id }})"
          branch: ${{ env.DEFAULT_BRANCH }}
          file_pattern: ${{ env.POSTS_DIR }}/*.md
          commit_user_name: "Content Bot"
          commit_user_email: "actions@github.com"
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN }}