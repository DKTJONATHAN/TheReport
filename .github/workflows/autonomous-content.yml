How can you make this yml search for the most appropriate images on splash that are most appropriate and most closest related to the content of each article and without falling back 

name: Autonomous Content Publisher

on:
  schedule:
    - cron: '0 1 * * *'   # 4AM EAT (Tech)
    - cron: '0 5 * * *'   # 8AM EAT (Finance)
    - cron: '0 10 * * *'  # 1PM EAT (Politics)
    - cron: '0 12 * * *'  # 3PM EAT (Social)
  workflow_dispatch:
    inputs:
      manual_topic:
        description: 'Force a topic (optional)'
        required: false
        default: ''

permissions:
  contents: write

env:
  DEFAULT_BRANCH: main
  POSTS_DIR: src/content/posts

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ env.DEFAULT_BRANCH }}
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Generate article with Gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          MANUAL_TOPIC: ${{ inputs.manual_topic }}
        run: |
          python << 'EOF'
          import os, json, datetime, requests, re, random, time

          # --- 1. CONFIGURATION & TOPIC ---
          date_str = datetime.datetime.utcnow().date().strftime("%Y-%m-%d")
          current_hour_utc = datetime.datetime.utcnow().hour
          
          manual_input = os.environ.get('MANUAL_TOPIC', '').strip()
          if manual_input:
              topic = manual_input
          else:
              if current_hour_utc < 3: topic = 'tech'
              elif current_hour_utc < 8: topic = 'finance'
              elif current_hour_utc < 11: topic = 'international-politics'
              else: topic = 'kenyan-social'
          
          print(f"ðŸŽ¯ Selected Topic: {topic}")

          # --- 2. IMAGE HELPER ---
          def get_real_image(query):
              access_key = os.environ.get("UNSPLASH_ACCESS_KEY")
              fallback = "https://images.unsplash.com/photo-1504711434969-e33886168f5c?auto=format&fit=crop&w=1200"
              if not access_key:
                  safe_query = query.replace(" ", "-")
                  return f"https://image.pollinations.ai/prompt/minimalist-abstract-3d-render-of-{safe_query}-no-humans?width=1200&height=630&nologo=true"
              url = f"https://api.unsplash.com/photos/random?query={query}&orientation=landscape&client_id={access_key}"
              try:
                  resp = requests.get(url, timeout=10)
                  if resp.status_code == 200:
                      return resp.json()['urls']['regular']
              except: pass
              return fallback

          # --- 3. DYNAMIC PROMPTS ---
          hooks = [
             "A Direct Question: Start immediately with a hard-hitting analytical question.",
             "A Shocking Statistic: Start with a complex figure and explain its deeper meaning.",
             "A Cynical Observation: Start by critically challenging a common global belief.",
             "A Bold Critique: Start by identifying a specific group or policy and analyzing its failure."
          ]
          selected_hook = random.choice(hooks)

          if topic == 'tech':
              focus = "Global Emerging Tech (AI, Space, Quantum). NO Kenya mentions."
              angle = "A dangerous breakthrough."
          elif topic == 'finance':
              focus = "Finance/Business. NO generic IMF stories."
              angle = "Money and power dynamics often hidden from public view."
          else:
              focus = f"Topic: {topic}. Provide deep geopolitical analysis."
              angle = "An ignored scandal, underdog story, or systemic shift."

          # --- 4. CONSTRUCT PROMPT ---
          spec_text = f"""
          You are an autonomous content agent for jonathanmwaniki.co.ke.
          TASK: Write a news article about: {focus}
          ANGLE: {angle}
          OPENING: {selected_hook}
          *** STRICT OUTPUT FORMAT ***
          TITLE: [Insert punchy title]
          DESCRIPTION: [Insert 2-sentence description]
          CATEGORY: [One of: Business, Sports, Politics, Entertainment, Technology, Education, Opinion]
          TAGS: [tag1, tag2, tag3]
          IMAGE_KEYWORD: [Search term for Unsplash]
          BODY:
          [Write the full 1500-word article here using ## Headers. NO Title at start.]
          *** CONTENT RULES ***
          - 6 Distinct Sections (250 words each).
          - USE COMMAS INSTEAD OF EM-DASHES (â€”).
          - Go deep. No fluff.
          """

          # --- 5. CALL GEMINI (UPDATED: Gemini 3 Flash Preview) ---
          api_key = os.environ.get("GEMINI_API_KEY")
          if not api_key: raise SystemExit("Missing GEMINI_API_KEY")

          # We use the v1beta endpoint for the preview model
          url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key={api_key}"
          headers = { "Content-Type": "application/json" }
          
          # Safety settings to allow geopolitical and critical discussion
          safety_settings = [
              {"category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE"},
              {"category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE"},
              {"category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE"},
              {"category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE"}
          ]

          payload = {
              "contents": [{ "parts": [{ "text": spec_text }] }],
              "safetySettings": safety_settings
          }

          max_retries = 5
          full_text = ""
          
          for attempt in range(max_retries):
              try:
                  resp = requests.post(url, headers=headers, json=payload, timeout=160)
                  if resp.status_code == 200:
                      result = resp.json()
                      if "candidates" in result and result["candidates"][0]["content"]["parts"]:
                          full_text = result["candidates"][0]["content"]["parts"][0]["text"]
                          break
                      else:
                          print(f"âš ï¸ Attempt {attempt+1}: Content was filtered by safety layer.")
                  else:
                      print(f"âŒ Attempt {attempt+1}: Error {resp.status_code} - {resp.text[:400]}")
                  
                  time.sleep(30)
              except Exception as e:
                  print(f"âš ï¸ Network/Request Error: {e}")
                  time.sleep(30)

          if not full_text: 
              raise SystemExit("Failed to get content from Gemini.")

          # --- 6. PARSE & SCRUB ---
          parsed = { "TITLE": f"Daily {topic.capitalize()}", "DESCRIPTION": "Latest update.", "CATEGORY": "Opinion", "TAGS": "news", "IMAGE_KEYWORD": topic, "BODY": "" }
          current_section = None
          
          for line in full_text.splitlines():
              clean_line = line.strip().replace("**", "")
              if clean_line.startswith("TITLE:"): parsed["TITLE"] = clean_line.replace("TITLE:", "").strip()
              elif clean_line.startswith("DESCRIPTION:"): parsed["DESCRIPTION"] = clean_line.replace("DESCRIPTION:", "").strip()
              elif clean_line.startswith("CATEGORY:"): parsed["CATEGORY"] = clean_line.replace("CATEGORY:", "").strip()
              elif clean_line.startswith("TAGS:"): parsed["TAGS"] = clean_line.replace("TAGS:", "").strip()
              elif clean_line.startswith("IMAGE_KEYWORD:"): parsed["IMAGE_KEYWORD"] = clean_line.replace("IMAGE_KEYWORD:", "").strip()
              elif clean_line.startswith("BODY:"): current_section = "BODY"
              elif current_section == "BODY": parsed["BODY"] += line + "\n"

          # ðŸ§¹ Em-Dash Scrubber
          for key in ["TITLE", "DESCRIPTION", "BODY"]:
              text = parsed[key]
              text = text.replace("â€”", ", ").replace("â€“", ", ").replace("--", ", ")
              text = re.sub(r',\s*,', ',', text)
              parsed[key] = text.strip()

          # --- 7. ASSEMBLE FINAL FILE ---
          image_url = get_real_image(parsed['IMAGE_KEYWORD'])
          slug = re.sub(r'[^a-z0-9-]', '-', parsed["TITLE"].lower())
          slug = re.sub(r'-+', '-', slug).strip('-')
          tag_list = [t.strip() for t in parsed["TAGS"].split(',')]

          final_file = f"""---
          title: "{parsed['TITLE'].replace('"', "'")}"
          description: "{parsed['DESCRIPTION'].replace('"', "'")}"
          date: "{date_str}"
          author: "Jonathan Mwaniki"
          image: "{image_url}"
          imageCaption: "Image for {parsed['IMAGE_KEYWORD']}"
          imageAlt: "{parsed['IMAGE_KEYWORD']}"
          category: "{parsed['CATEGORY']}"
          tags: {json.dumps(tag_list)}
          featured: true
          draft: false
          slug: "{slug}"
          ---

          # {parsed['TITLE']}

          {parsed['BODY']}

          <div class="article-meta">
            <p><strong>Published:</strong> {date_str}</p>
            <p><strong>Author:</strong> Jonathan Mwaniki</p>
            <p><strong>Tags:</strong> {parsed['TAGS']}</p>
          </div>
          """

          import textwrap
          final_file = textwrap.dedent(final_file).strip()
          out_dir = os.path.join(os.getcwd(), os.environ.get("POSTS_DIR", "src/content/posts"))
          os.makedirs(out_dir, exist_ok=True)
          with open(os.path.join(out_dir, f"{slug}.md"), "w", encoding="utf-8") as f:
              f.write(final_file)
          print(f"âœ… Success! Created {slug}.md")
          EOF

      - name: Commit and push article
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "content: publish daily article (${{ github.run_id }})"
          branch: ${{ env.DEFAULT_BRANCH }}
          file_pattern: ${{ env.POSTS_DIR }}/*.md
          commit_user_name: "Content Bot"
          commit_user_email: "actions@github.com"
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN }}