name: Autonomous Content Publisher

on:
  workflow_dispatch:

permissions:
  contents: write

env:
  DEFAULT_BRANCH: main
  POSTS_DIR: src/content/posts

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ env.DEFAULT_BRANCH }}
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Generate article with Gemini 3 Flash
        id: generate_article
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python << 'EOF'
          import os, json, datetime, textwrap, requests

          with open("config/super-agent.json", "r", encoding="utf-8") as f:
            cfg = json.load(f)

          mission = cfg["mission_statement"]["primary"]
          voice = cfg["CRITICAL_WRITING_RULES"]["VOICE_REQUIREMENTS"]
          article_spec = cfg["content_strategy"]["article_specifications"]
          date_str = datetime.datetime.utcnow().date().strftime("%Y-%m-%d")

          system_prompt = f"""
          You are an autonomous content agent for jonathanmwaniki.co.ke.

          Mission:
          {mission}

          Hard rules:
          - Word count between {article_spec["word_count"]["minimum"]} and {article_spec["word_count"]["maximum"]}, target {article_spec["word_count"]["target"]}.
          - Use tone: {voice["tone"]}.
          - Perspective: {voice["perspective"]}.
          - Sentence rhythm: {voice["sentence_structure"]["rhythm"]}.
          - ABSOLUTE NEVER: em dashes, any citation syntax, banned phrases, summary/conclusion sections.

          Output:
          - Full markdown file starting with YAML frontmatter using ---.
          - Include title, description, date, author, image, imageCaption, imageAlt, category, tags, featured, draft, slug.
          - date: "{date_str}"
          - author: "Jonathan Mwaniki"
          - featured: true
          - draft: false
          - After frontmatter, first line in body is "# EXACT TITLE".
          - End with a numbered action list and then:
            <div class="article-meta">
              <p><strong>Published:</strong> {date_str}</p>
              <p><strong>Author:</strong> Jonathan Mwaniki</p>
              <p><strong>Tags:</strong> tag1, tag2, tag3, tag4</p>
            </div>
          """

          api_key = os.environ.get("GEMINI_API_KEY")
          if not api_key:
            raise SystemExit("Missing GEMINI_API_KEY")

          url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent"

          payload = {
            "contents": [
              {
                "parts": [
                  {
                    "text": system_prompt
                  }
                ]
              }
            ]
          }

          headers = {
            "x-goog-api-key": api_key,
            "Content-Type": "application/json"
          }

          resp = requests.post(url, headers=headers, data=json.dumps(payload), timeout=120)
          if resp.status_code != 200:
            raise SystemExit(f"Gemini API error {resp.status_code}: {resp.text[:500]}")

          data = resp.json()
          try:
            text = data["candidates"][0]["content"]["parts"][0]["text"]
          except Exception:
            raise SystemExit(f"Unexpected Gemini response: {json.dumps(data)[:800]}")

          # Write output path and content for next step
          out_dir = os.path.join(os.getcwd(), os.environ.get("POSTS_DIR", "src/content/posts"))
          os.makedirs(out_dir, exist_ok=True)
          out_path = os.path.join(out_dir, "test-article.md")
          with open(out_path, "w", encoding="utf-8") as f:
            f.write(text)

          print(f"Article written to {out_path}")
          EOF

      - name: Commit and push article
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "content: publish article test-article"
          branch: ${{ env.DEFAULT_BRANCH }}
          file_pattern: ${{ env.POSTS_DIR }}/test-article.md
          commit_user_name: "Content Bot"
          commit_user_email: "actions@github.com"
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}