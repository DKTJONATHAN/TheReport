name: International News (NewsAPI Version)

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'   # 5:00 AM EAT (Politics)
    - cron: '0 5 * * *'   # 8:00 AM EAT (Sports)
    - cron: '0 8 * * *'   # 11:00 AM EAT (Business)
    - cron: '0 11 * * *'  # 2:00 PM EAT (Tech)
    - cron: '0 14 * * *'  # 5:00 PM EAT (Sports)
    - cron: '0 18 * * *'  # 9:00 PM EAT (Entertainment)
  workflow_dispatch:
    inputs:
      manual_topic:
        description: 'Force a topic'
        required: false
        default: ''

permissions:
  contents: write

env:
  DEFAULT_BRANCH: main
  POSTS_DIR: src/content/posts
  MEMORY_FILE: .github/scrape_memory.json

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ env.DEFAULT_BRANCH }}
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests google-genai

      - name: Generate article with NewsAPI & Gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          MANUAL_TOPIC: ${{ github.event.inputs.manual_topic }}
          MEMORY_FILE: ${{ env.MEMORY_FILE }}
          CRON_SCHEDULE: ${{ github.event.schedule }}
        run: |
          python << 'EOF'
          import os, json, datetime, requests, re, random, hashlib
          from google import genai
          from google.genai import types

          # --- 1. CONFIG ---
          cron = os.environ.get('CRON_SCHEDULE', '')
          current_hour = datetime.datetime.utcnow().hour
          manual = os.environ.get('MANUAL_TOPIC', '').strip().lower()
          
          topic_map = {'0 2 * * *': 'politics', '0 5 * * *': 'sports', '0 8 * * *': 'business', '0 11 * * *': 'technology', '0 14 * * *': 'sports', '0 18 * * *': 'entertainment'}
          topic = manual if manual else topic_map.get(cron, 'politics')

          # --- 2. IMAGE FALLBACK ---
          def get_image(kw, tp):
              key = os.environ.get("UNSPLASH_ACCESS_KEY")
              fallback = "https://images.unsplash.com/photo-1504711432869-efd597cdd042"
              if not key: return fallback
              for q in [kw, tp, "news"]:
                  try:
                      r = requests.get(f"https://api.unsplash.com/photos/random?query={q}&orientation=landscape&client_id={key}", timeout=10)
                      if r.status_code == 200: return r.json()['urls']['regular']
                  except: continue
              return fallback

          # --- 3. FETCH DATA FROM NEWS API ---
          news_key = os.environ.get("NEWS_API_KEY")
          memory_path = os.environ.get('MEMORY_FILE')
          memory = json.load(open(memory_path)) if os.path.exists(memory_path) else []
          
          # Query NewsAPI specifically for CNN articles in the chosen category
          url = f"https://newsapi.org/v2/everything?sources=cnn&q={topic}&language=en&sortBy=publishedAt&apiKey={news_key}"
          response = requests.get(url).json()
          
          articles = response.get('articles', [])
          target_article = None
          
          for art in articles:
              content = art.get('content', '')
              title = art.get('title', '')
              link = art.get('url', '')
              u_hash = hashlib.md5(link.encode()).hexdigest()
              
              # Ensure it's not a duplicate and has enough content for Gemini to expand
              if u_hash not in memory and len(content) > 100:
                  target_article = art
                  final_hash = u_hash
                  break

          if not target_article:
              print("No new articles found via NewsAPI."); exit(0)

          # --- 4. REWRITE WITH GEMINI ---
          prompt = f"""STRICT REPORTING MODE. 
          UK English. No em-dashes (use commas). 
          Target length: 1400 words.
          
          SOURCE DATA:
          Title: {target_article['title']}
          Description: {target_article['description']}
          Snippet: {target_article['content']}

          TASK: Based on this news snippet, research and write a full detailed report.
          OUTPUT FORMAT:
          TITLE: [headline]
          DESCRIPTION: [summary]
          CATEGORY: [{topic.title()}]
          TAGS: [3 tags]
          IMAGE_KEYWORD: [2 words]
          BODY: [Full article with ## headers: Background, Detailed Analysis, Global Impact, Reactions, Outlook]"""

          client = genai.Client(api_key=os.environ.get('GEMINI_API_KEY'))
          resp = client.models.generate_content(model="gemini-2.0-flash", contents=prompt)
          
          # --- 5. PARSE & CLEAN ---
          res = resp.text.strip()
          parsed = {"TITLE": "", "DESC": "", "IMG": topic, "BODY": ""}
          section = None
          for line in res.splitlines():
              if line.startswith("TITLE:"): parsed["TITLE"] = line.replace("TITLE:", "").strip()
              elif line.startswith("DESCRIPTION:"): parsed["DESC"] = line.replace("DESCRIPTION:", "").strip()
              elif line.startswith("IMAGE_KEYWORD:"): parsed["IMG"] = line.replace("IMAGE_KEYWORD:", "").strip()
              elif line.startswith("BODY:"): section = "BODY"
              elif section == "BODY": parsed["BODY"] += line + "\n"

          for k in ["TITLE", "DESC", "BODY"]:
              parsed[k] = parsed[k].replace("—", ", ").replace("–", ", ").replace("--", ", ")

          img_url = get_image(parsed["IMG"], topic)
          slug = re.sub(r'[^a-z0-9-]', '-', parsed["TITLE"].lower()).strip('-')

          final_md = f"""---
          title: "{parsed['TITLE']}"
          description: "{parsed['DESC']}"
          date: "{datetime.datetime.utcnow().date().strftime('%Y-%m-%d')}"
          author: "Jonathan Mwaniki"
          image: "{img_url}"
          category: "{topic.title()}"
          slug: "{slug}"
          ---

          # {parsed['TITLE']}

          {parsed['BODY']}
          """
          
          # --- 6. SAVE ---
          import textwrap
          out_dir = os.environ.get("POSTS_DIR")
          os.makedirs(out_dir, exist_ok=True)
          with open(os.path.join(out_dir, f"{slug}.md"), "w") as f:
              f.write(textwrap.dedent(final_md).strip())
          
          memory.append(final_hash)
          with open(memory_path, 'w') as f: json.dump(memory[-200:], f)
          print(f"Success: Published {slug}")
          EOF

      - name: Commit and push article
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "content: publish newsapi report"
          branch: ${{ env.DEFAULT_BRANCH }}
          file_pattern: 'src/content/posts/*.md .github/scrape_memory.json'