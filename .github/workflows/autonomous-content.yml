name: Autonomous Real-Time Publisher (British Edition)

on:
  schedule:
    - cron: '0 1,6,10,15 * * *' # 4 AM, 9 AM, 1 PM, 6 PM EAT
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests groq apify-client

      - name: Crawl and Generate
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          APIFY_API_TOKEN: ${{ secrets.APIFY_API_TOKEN }}
          POSTS_DIR: src/content/posts
        run: |
          python << 'EOF'
          import os, json, datetime, requests, re
          from groq import Groq
          from apify_client import ApifyClient

          # 1. SETUP
          now = datetime.datetime.utcnow()
          date_str = now.strftime('%Y-%m-%d')
          
          client = Groq(api_key=os.environ.get("GROQ_API_KEY"))
          apify = ApifyClient(token=os.environ.get("APIFY_API_TOKEN"))

          # 2. CRAWL KENYANS.CO.KE (For facts only)
          print("Crawling kenyans.co.ke for real-time intelligence...")
          run_input = {
              "startUrls": [{"url": "https://www.kenyans.co.ke/news"}],
              "maxCrawlPages": 2,
              "crawlerType": "cheerio",
              "removeElementsCssSelector": "nav, footer, .sidebar, .ads, script, style"
          }
          
          try:
              run = apify.actor("apify/website-content-crawler").call(run_input=run_input)
              raw_data = ""
              for item in apify.dataset(run["defaultDatasetId"]).iterate_items():
                  # We strip the source title to just get facts
                  raw_data += f"\nTOPIC: {item.get('metadata', {}).get('title')}\nDETAILS: {item.get('markdown', '')[:2500]}\n"
          except Exception as e:
              print(f"Crawler Failed: {e}")
              exit(1)

          if not raw_data:
              print("No data found. Exiting.")
              exit(0)

          # 3. SINGLE-SHOT STRICT GENERATION
          system_msg = """
          You are a senior British International Correspondent based in Nairobi.
          
          CRITICAL LANGUAGE RULES:
          1. STRICTLY BRITISH ENGLISH (UK Spelling: 'colour', 'honour', 'realise').
          2. ABSOLUTELY NO SWAHILI. NO SHENG. NO LOCAL SLANG.
          3. Tone: Cynical, fearless, and intellectually savage. Think "BBC gone rogue". 
          4. Approach: You are analyzing Kenyan events with a sharp, critical international eye. Call out incompetence and corruption using sophisticated but cutting English.
          
          OUTPUT FORMAT:
          Return ONLY a valid JSON object with these exact keys:
          - title: A sharp, witty British-style headline.
          - description: A dry, cynical 2-sentence summary.
          - image_keyword: A cinematic prompt for an image.
          - body: A 1500-word article in Markdown. Use ## Headers.
          - tags: A list of 5 tags.
          """

          user_msg = f"""
          DATE: {date_str}
          INTELLIGENCE REPORT:
          {raw_data}

          TASK: Write a 1500-word exposÃ© on the most significant story above.
          - Deconstruct the political/social failure visible in the story.
          - Use rhetorical wit and British sarcasm.
          - Name names. Be unapologetic but articulate.
          """

          try:
              chat = client.chat.completions.create(
                  model="llama-3.3-70b-versatile",
                  messages=[{"role": "system", "content": system_msg}, {"role": "user", "content": user_msg}],
                  response_format={"type": "json_object"},
                  temperature=0.85 
              )
              res = json.loads(chat.choices[0].message.content)
          except Exception as e:
              print(f"Generation Failed: {e}")
              exit(1)

          # 4. ASSEMBLY
          # Direct save. No second pass to ruin the language.
          slug = re.sub(r'[^a-z0-9-]', '-', res['title'].lower()).strip('-')
          
          final_md = f"""---
          title: "{res['title']}"
          description: "{res['description']}"
          date: "{date_str}"
          imageKeyword: "{res['image_keyword']}"
          tags: {json.dumps(res['tags'])}
          featured: true
          ---

          {res['body']}

          """

          os.makedirs(os.environ['POSTS_DIR'], exist_ok=True)
          with open(f"{os.environ['POSTS_DIR']}/{slug}.md", "w", encoding="utf-8") as f:
              f.write(final_md)
          EOF

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "content: British edition update [${{ github.run_id }}]"