name: Autonomous Content Publisher

on:
  schedule:
    - cron: '0 1 * * *'   # 4AM EAT (1:00 UTC)
    - cron: '0 5 * * *'   # 8AM EAT (5:00 UTC)
    - cron: '0 10 * * *'  # 1PM EAT (10:00 UTC)
    - cron: '0 12 * * *'  # 3PM EAT (12:00 UTC)
  workflow_dispatch:

permissions:
  contents: write

env:
  DEFAULT_BRANCH: main
  POSTS_DIR: src/content/posts

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        topic: [tech, finance, international-politics, kenyan-social]
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ env.DEFAULT_BRANCH }}
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pyyaml

      - name: Generate article with Gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TOPIC: ${{ matrix.topic }}
        run: |
          python << 'EOF'
          import os, json, datetime, requests, yaml, re

          date_str = datetime.datetime.utcnow().date().strftime("%Y-%m-%d")
          topic = os.environ.get('TOPIC', 'tech')

          spec_text = f"""
          You are an autonomous content agent for jonathanmwaniki.co.ke.

          IMPORTANT: Focus ONLY on '{topic}' for this article. Choose one current, timely story in this pillar using your latest knowledge.

          HIGH-LEVEL MISSION:
          Deliver fast, entertaining, and accurate Kenyan and international news, tech, finance, politics, and gossip that exposes untold stories with sharp, fearless commentary and feels like a smart friend breaking it all down.

          VOICE AND STYLE:
          - Tone: angry/passionate Kenyan journalist.
          - Perspective: first-person where natural ("I walked into...", "I saw...").
          - Rhythm: SHORT sentences, vary length, keep reader moving.
          - Signature phrases to sprinkle in naturally:
            * "I could not lie"
            * "Let that sink in"
            * "Here's the thing"
            * "Think about that"
            * "When you combine X + Y + Z"
            * "Here's what needs to happen"
            * "Kenyans need to demand"
            * "Let me be clear"
          - Kenyan context: use sheng if natural; add Nairobi / Kenya references; connect Kenya to global trends.
          - Emphasis: bold numbers (e.g. **144 billion shillings**), ask direct questions, end with strong numbered action list.

          HARD RULES (ABSOLUTE NEVER):
          - Do NOT use em dashes (—) anywhere.
          - Do NOT use any citation syntax like [1], [web:1], [cite:x] anywhere.
          - Do NOT use academic / AI phrases like:
            "According to sources", "Studies show", "Research indicates", "Experts say",
            "It is worth noting", "In conclusion", "To summarize",
            "delve into", "dive deep", "unpack", "navigate", "landscape",
            "tapestry", "realm", "robust", "leverage".
          - Do NOT use $ for dollars or LaTeX math.
          - Do NOT add a separate summary or conclusion section at the end.

          ARTICLE SPEC:
          - Word count: between 1000 and 2000 words, target about 1500.
          - Topic: choose one story that fits '{topic}' pillar.
          - Audience: global readers + Kenyans + diaspora.
          - Angle: sharp, fearless commentary with ground-level examples.

          EXACT ARTICLE FORMAT (MARKDOWN):

          1) YAML FRONTMATTER at the top, between --- lines, exactly in this shape:

          ---
          title: "Your punchy title here (<= 60 characters)"
          description: "First 2 lines of article or ~150 chars with main hook"
          date: "{date_str}"
          author: "Jonathan Mwaniki"
          image: "https://images.unsplash.com/photo-xxxxx?w=1200"
          imageCaption: "One descriptive sentence about the image"
          imageAlt: "5-10 word SEO description of the image"
          category: "{topic}"          # Use exactly: tech, finance, international-politics, or kenyan-social
          tags: ["keyword1", "keyword2", "keyword3", "keyword4"]
          featured: true
          draft: false
          slug: "lowercase-kebab-case-no-dates"
          ---

          - Make sure slug is lowercase-kebab-case with no dates.

          2) BODY STRUCTURE:

          First line after frontmatter:
          # EXACT TITLE

          Replace EXACT TITLE with the same title text (no quotes).

          Then:
          - 2–3 opening paragraphs in my Kenyan voice:
            * Hook immediately.
            * Use at least one personal or Nairobi observation.
            * Set up the core tension or question.

          Sections:
          - Use H2 headings: "## Short Meaningful Header" (max 6 words, descriptive).
          - 2–3 paragraphs per section.
          - No headings like "Introduction", "Conclusion", "Background".

          Ending:
          - Before the final meta block, include a numbered action list (1., 2., 3.) or a strong call-to-action aimed at readers (what they should do, demand, or pay attention to).
          - After that, end with this EXACT HTML block, with date and tags filled in consistently:

          <div class="article-meta">
            <p><strong>Published:</strong> {date_str}</p>
            <p><strong>Author:</strong> Jonathan Mwaniki</p>
            <p><strong>Tags:</strong> tag1, tag2, tag3, tag4</p>
          </div>

          IMPORTANT:
          - No extra content after the article-meta div.
          - Keep everything in natural, human-sounding Kenyan English.
          """

          spec_text = spec_text.replace("{date_str}", date_str)
          spec_text = spec_text.replace("{topic}", topic)

          api_key = os.environ.get("GEMINI_API_KEY")
          if not api_key:
            raise SystemExit("Missing GEMINI_API_KEY")

          url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent"

          payload = {
            "contents": [
              {
                "parts": [
                  {
                    "text": spec_text
                  }
                ]
              }
            ]
          }

          headers = {
            "x-goog-api-key": api_key,
            "Content-Type": "application/json"
          }

          resp = requests.post(url, headers=headers, data=json.dumps(payload), timeout=120)
          if resp.status_code != 200:
            raise SystemExit(f"Gemini API error {resp.status_code}: {resp.text[:500]}")

          data = resp.json()
          try:
            text = data["candidates"][0]["content"]["parts"][0]["text"]
          except Exception:
            raise SystemExit(f"Unexpected Gemini response: {json.dumps(data)[:800]}")

          # Extract slug from frontmatter
          frontmatter_match = re.search(r'^---s*
(.*?)
---', text, re.DOTALL)
          if frontmatter_match:
            frontmatter_str = frontmatter_match.group(1)
            try:
              frontmatter = yaml.safe_load(frontmatter_str)
              slug = frontmatter.get('slug', f'{topic}-article-{date_str}')
            except:
              slug = f'{topic}-article-{date_str}'
          else:
            slug = f'{topic}-article-{date_str}'

          out_dir = os.path.join(os.getcwd(), os.environ.get("POSTS_DIR", "src/content/posts"))
          os.makedirs(out_dir, exist_ok=True)
          
          out_filename = f"{slug}.md"
          out_path = os.path.join(out_dir, out_filename)
          
          with open(out_path, "w", encoding="utf-8") as f:
            f.write(text)

          print(f"Article written to {out_path}")
          EOF

      - name: Commit and push article
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "content: publish ${{ matrix.topic }} daily article (${{ github.run_id }})"
          branch: ${{ env.DEFAULT_BRANCH }}
          file_pattern: ${{ env.POSTS_DIR }}/*.md
          commit_user_name: "Content Bot"
          commit_user_email: "actions@github.com"
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN }}