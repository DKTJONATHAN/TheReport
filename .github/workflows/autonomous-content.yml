name: Auto kenya

on:
  schedule:
    - cron: '0 0 * * *'   # 3AM EAT (Sports)
    - cron: '0 6 * * *'   # 9AM EAT (Tech)
    - cron: '0 11 * * *'  # 2PM EAT (Finance)
    - cron: '0 14 * * *'  # 5PM EAT (Sports)
    - cron: '0 18 * * *'  # 9PM EAT (Finance)
    - cron: '0 22 * * *'  # 1AM EAT (Tech)
  workflow_dispatch:
    inputs:
      manual_topic:
        description: 'Force a topic (sports, technology, business)'
        required: false
        default: ''

permissions:
  contents: write

env:
  DEFAULT_BRANCH: main
  POSTS_DIR: src/content/posts

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ env.DEFAULT_BRANCH }}
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests google-genai apify-client

      - name: Generate article with Gemini
        env:
          GEMINI_WRITE_KEY: ${{ secrets.GEMINI_WRITE_KEY }}
          APIFY_API_TOKEN: ${{ secrets.APIFY_API_TOKEN }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          MANUAL_TOPIC: ${{ inputs.manual_topic }}
          POSTS_DIR: src/content/posts
        run: |
          python << 'EOF'
          import os, json, datetime, requests, re, random, time, textwrap
          from google import genai
          from google.genai import types
          from apify_client import ApifyClient

          # --- 1. CONFIGURATION ---
          date_str = datetime.datetime.utcnow().date().strftime("%Y-%m-%d")
          current_hour_utc = datetime.datetime.utcnow().hour
          manual_input = os.environ.get('MANUAL_TOPIC', '').strip().lower()
          
          if manual_input in ['sports', 'technology', 'business', 'politics']:
              topic = manual_input
          else:
              if current_hour_utc == 0 or current_hour_utc == 14: topic = 'sports'
              elif current_hour_utc == 6 or current_hour_utc == 22: topic = 'technology'
              elif current_hour_utc == 18: topic = 'finance'
              else: topic = 'business'
          
          url_map = {
              'technology': 'https://techweez.com/',
              'sports': 'https://www.mozzartsport.co.ke/',
              'business': 'https://www.standardmedia.co.ke/business',
              'finance': 'https://www.standardmedia.co.ke/business',
              'politics': 'https://www.kenyans.co.ke/news'
          }
          target_url = url_map.get(topic, 'https://www.kenyans.co.ke/news')

          # --- 2. FETCH ---
          apify = ApifyClient(os.environ.get("APIFY_API_TOKEN"))
          crawl_text = ""
          try:
              run = apify.actor("apify/website-content-crawler").call(run_input={"startUrls": [{"url": target_url}], "maxCrawlPages": 1})
              for item in apify.dataset(run["defaultDatasetId"]).iterate_items():
                  crawl_text += item.get('markdown', '')[:4000] 
          except: exit(0)

          # --- 3. PROMPT (STRICT ANTI-CITATION) ---
          cat_map = {'sports':'Sports', 'technology':'Technology', 'business':'Business', 'politics': 'Politics', 'finance': 'Business'}
          display_category = cat_map.get(topic, 'General')

          prompt = f'''STRICT JOURNALISM MODE. 
          SOURCE MATERIAL: {crawl_text}

          TASK: Write a factual news article. 
          
          STRICT RULES:
          1. NO CITATIONS: Do not use square brackets like [source.com] or [1]. 
          2. NO URLS: Do not include any website links in the body text.
          3. NO EXTERNAL FOOTERS: Do not add "Source:" or "Crawled from" at the end.
          4. TONE: Neutral, professional UK English.
          5. DASHES: NEVER use em-dashes (—) or en-dashes (–). Use commas or colons.

          OUTPUT FORMAT:
          TITLE: [Headline]
          DESCRIPTION: [Summary]
          CATEGORY: [{display_category}]
          TAGS: [Tags]
          IMAGE_KEYWORD: [Keyword]
          BODY:
          [Article content only]'''

          # --- 4. EXECUTION ---
          client = genai.Client(api_key=os.environ.get("GEMINI_WRITE_KEY"))
          model_id = "gemini-2.5-flash"
          
          try:
              resp = client.models.generate_content(
                  model=model_id,
                  contents=prompt,
                  config=types.GenerateContentConfig(temperature=0.1)
              )
              full_text = resp.text.strip()
          except: exit(1)

          # --- 5. PARSE & CLEANUP ---
          parsed = {"TITLE":"", "DESCRIPTION":"", "CATEGORY":display_category, "TAGS":"", "IMAGE_KEYWORD":"", "BODY":""}
          body_started = False
          for line in full_text.splitlines():
              clean = line.strip().replace("**", "")
              if clean.startswith("TITLE:"): parsed["TITLE"] = clean.replace("TITLE:", "").strip()
              elif clean.startswith("DESCRIPTION:"): parsed["DESCRIPTION"] = clean.replace("DESCRIPTION:", "").strip()
              elif clean.startswith("TAGS:"): parsed["TAGS"] = clean.replace("TAGS:", "").strip()
              elif clean.startswith("IMAGE_KEYWORD:"): parsed["IMAGE_KEYWORD"] = clean.replace("IMAGE_KEYWORD:", "").strip()
              elif clean.startswith("BODY:"): body_started = True
              elif body_started: parsed["BODY"] += line + "\n"

          # REGEX CLEANUP: Remove any remaining [anything.com] or [1] citations
          parsed["BODY"] = re.sub(r'\[.*?\]', '', parsed["BODY"])
          # Remove em/en dashes just in case
          parsed["BODY"] = parsed["BODY"].replace("—", ", ").replace("–", ", ")

          # --- 6. SAVE ---
          slug = re.sub(r'[^a-z0-9-]', '-', parsed["TITLE"].lower()).strip('-')
          tag_list = [t.strip() for t in parsed["TAGS"].split(',')]
          
          final_file = f"""---
          title: "{parsed['TITLE'].replace('"', "'")}"
          description: "{parsed['DESCRIPTION'].replace('"', "'")}"
          date: "{date_str}"
          author: "Jonathan Mwaniki"
          category: "{parsed['CATEGORY']}"
          tags: {json.dumps(tag_list)}
          slug: "{slug}"
          ---

          {parsed['BODY'].strip()}
          """

          os.makedirs(os.environ.get("POSTS_DIR"), exist_ok=True)
          with open(os.path.join(os.environ.get("POSTS_DIR"), f"{slug}.md"), "w") as f:
              f.write(textwrap.dedent(final_file).strip())
          EOF

      - name: Commit and push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "content: publish news"
          branch: ${{ env.DEFAULT_BRANCH }}