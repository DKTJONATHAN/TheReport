name: Human-Centric Content Publisher

on:
  schedule:
    - cron: '0 1 * * *'   # 4AM EAT
    - cron: '0 11 * * *'  # 2PM EAT
  workflow_dispatch:

permissions:
  contents: write

env:
  POSTS_DIR: src/content/posts

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Generate Grounded Content
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
        run: |
          python << 'EOF'
          import os, json, datetime, requests, re, random, time

          # --- 1. LOCAL CONTEXT ENGINE (Kenya 2026) ---
          local_events = [
              "The shift in Nairobi's tech scene toward local-first AI solutions.",
              "Recent infrastructure developments in Upper Hill and Westlands.",
              "How the latest 2026 tax policies are affecting digital nomads in Kenya.",
              "The growth of the 'Silicon Savannah' beyond Nairobi to Kisumu and Mombasa.",
              "Local cultural shifts: Why Kenyan youth are moving back to long-form storytelling."
          ]
          
          personas = [
              {"name": "The Nairobi Insider", "tone": "Direct, uses Nairobi landmarks for context, avoids corporate jargon."},
              {"name": "The Kenyan Analyst", "tone": "Analytical but grounded, connects global shifts to local wallet impact."},
              {"name": "The Modern Storyteller", "tone": "Narrative-driven, focuses on people and community impact."}
          ]

          current_persona = random.choice(personas)
          current_event = random.choice(local_events)

          # --- 2. THE PROMPT (STRICTLY NON-ROBOTIC) ---
          spec_text = f"""
          Write a 1200-word article. 
          VOICE: {current_persona['name']}. TONE: {current_persona['tone']}.
          
          CONTEXT: Weave in this specific Kenyan detail: {current_event}
          
          ANTI-BOT RULES:
          - NEVER use 'geopolitical', 'landscape', 'tapestry', 'delve', or 'pivotal'.
          - NEVER start with 'In today's world...' or 'In the digital age...'.
          - Use short, punchy sentences. Mix in one-sentence paragraphs for emphasis.
          - No em-dashes (â€”). Use commas or periods.

          FORMAT:
          TITLE: [Your Title]
          DESCRIPTION: [2-sentence summary]
          IMAGE_PROMPT: [5-word physical scene description]
          CATEGORY: [Business/Tech/Opinion]
          BODY:
          [Article starts here]
          """

          # --- 3. ROBUST API CALL (GEMINI 2.5 FLASH) ---
          api_key = os.environ.get("GEMINI_API_KEY")
          # Using the 2026 stable endpoint and model
          url = f"https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent?key={api_key}"
          
          payload = {
              "contents": [{"parts": [{"text": spec_text}]}],
              "generationConfig": {"temperature": 0.9, "maxOutputTokens": 4000},
              "safetySettings": [
                  {"category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE"},
                  {"category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE"},
                  {"category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE"},
                  {"category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE"}
              ]
          }

          # Retry logic to handle 'candidates' missing or network errors
          full_text = ""
          for attempt in range(3):
              try:
                  resp = requests.post(url, json=payload, timeout=90)
                  res_data = resp.json()
                  if "candidates" in res_data and res_data["candidates"]:
                      full_text = res_data["candidates"][0]["content"]["parts"][0]["text"]
                      break
                  else:
                      print(f"Attempt {attempt+1}: Response blocked or empty. Reason: {res_data.get('promptFeedback')}")
              except Exception as e:
                  print(f"Error: {e}")
              time.sleep(5)

          if not full_text:
              print("Critical Failure: API did not return content.")
              exit(1)

          # --- 4. PARSING & IMAGE FETCH ---
          parsed = {"TITLE": "Untitled", "DESCRIPTION": "", "IMAGE_KEYWORD": "Nairobi", "CATEGORY": "Social"}
          lines = full_text.splitlines()
          for line in lines:
              if line.startswith("TITLE:"): parsed["TITLE"] = line.replace("TITLE:", "").strip()
              elif line.startswith("DESCRIPTION:"): parsed["DESCRIPTION"] = line.replace("DESCRIPTION:", "").strip()
              elif line.startswith("IMAGE_PROMPT:"): parsed["IMAGE_KEYWORD"] = line.replace("IMAGE_PROMPT:", "").strip()
              elif line.startswith("CATEGORY:"): parsed["CATEGORY"] = line.replace("CATEGORY:", "").strip()

          body_start = full_text.find("BODY:") + 5
          parsed["BODY"] = full_text[body_start:].strip()

          img_key = os.environ.get("UNSPLASH_ACCESS_KEY")
          img_url = "https://images.unsplash.com/photo-1523805009345-7448845a9e53" # Nairobi fallback
          if img_key:
              try:
                  s_url = f"https://api.unsplash.com/search/photos?query={parsed['IMAGE_KEYWORD']}&client_id={img_key}&per_page=1"
                  s_res = requests.get(s_url).json()
                  if s_res.get('results'):
                      img_url = s_res['results'][0]['urls']['regular']
              except: pass

          # --- 5. SAVE ---
          slug = re.sub(r'[^a-z0-9-]', '-', parsed["TITLE"].lower()).strip('-')
          final_md = f"""---
          title: "{parsed['TITLE']}"
          description: "{parsed['DESCRIPTION']}"
          date: "{datetime.datetime.utcnow().strftime('%Y-%m-%d')}"
          author: "Jonathan Mwaniki"
          image: "{img_url}"
          category: "{parsed['CATEGORY']}"
          ---

          {parsed['BODY']}
          """
          
          out_dir = os.environ.get('POSTS_DIR')
          os.makedirs(out_dir, exist_ok=True)
          with open(f"{out_dir}/{slug}.md", "w") as f:
              f.write(final_md)
          EOF

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "content: daily human-curated update"