name: Autonomous Content Publisher

on:
  schedule:
    - cron: '0 1 * * *'   # 4AM EAT (Tech)
    - cron: '0 5 * * *'   # 8AM EAT (Finance)
    - cron: '0 10 * * *'  # 1PM EAT (Politics)
    - cron: '0 12 * * *'  # 3PM EAT (Social)
  workflow_dispatch:
    inputs:
      manual_topic:
        description: 'Force a topic (optional)'
        required: false
        default: ''

permissions:
  contents: write

env:
  DEFAULT_BRANCH: main
  POSTS_DIR: src/content/posts

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ env.DEFAULT_BRANCH }}
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Generate article with Gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          MANUAL_TOPIC: ${{ inputs.manual_topic }}
        run: |
          python << 'EOF'
          import os, json, datetime, requests, re, random, time

          # --- CONFIGURATION ---
          date_str = datetime.datetime.utcnow().date().strftime("%Y-%m-%d")
          current_hour_utc = datetime.datetime.utcnow().hour
          
          # --- 1. TOPIC SELECTION ---
          manual_input = os.environ.get('MANUAL_TOPIC', '').strip()
          if manual_input:
              topic = manual_input
          else:
              # Time-based routing
              if current_hour_utc < 3: topic = 'tech'                # 4AM EAT
              elif current_hour_utc < 8: topic = 'finance'             # 8AM EAT
              elif current_hour_utc < 11: topic = 'international-politics' # 1PM EAT
              else: topic = 'kenyan-social'                            # 3PM EAT
          
          print(f"ðŸŽ¯ Selected Topic: {topic}")

          # --- 2. IMAGE HELPER ---
          def get_real_image(query):
              access_key = os.environ.get("UNSPLASH_ACCESS_KEY")
              fallback_image = "https://images.unsplash.com/photo-1504711434969-e33886168f5c?auto=format&fit=crop&w=1200"
              
              if not access_key:
                  safe_query = query.replace(" ", "-")
                  return f"https://image.pollinations.ai/prompt/minimalist-abstract-3d-render-of-{safe_query}-no-humans?width=1200&height=630&nologo=true"
              
              url = f"https://api.unsplash.com/photos/random?query={query}&orientation=landscape&client_id={access_key}"
              try:
                  resp = requests.get(url, timeout=10)
                  if resp.status_code == 200:
                      return resp.json()['urls']['regular']
              except Exception:
                  pass
              return fallback_image

          # --- 3. DYNAMIC PROMPTS ---
          hooks = [
             "A Direct Question: Start immediately with a hard-hitting question.",
             "A Shocking Statistic: Start with a number that makes no sense and explain it.",
             "A Cynical Observation: Start by mocking a common belief.",
             "A Direct Attack: Start by calling out a specific group."
          ]
          selected_hook = random.choice(hooks)

          if topic == 'tech':
              focus = "Global Emerging Tech (AI, Space, Quantum). NO Kenya mentions."
              angle = "A dangerous breakthrough."
          elif topic == 'finance':
              focus = "Finance/Business. NO generic IMF stories."
              angle = "Money they are hiding from us."
          else:
              focus = f"Topic: {topic}. NO generic corruption stories."
              angle = "An ignored scandal or underdog story."

          # --- 4. CONSTRUCT PROMPT ---
          spec_text = f"""
          You are an autonomous content agent for jonathanmwaniki.co.ke.
          
          TASK: Write a news article about: {focus}
          ANGLE: {angle}
          OPENING: {selected_hook} (Do NOT start with "I was sitting at...").

          *** STRICT OUTPUT FORMAT ***
          Do NOT write Markdown/YAML yourself. Provide raw data labeled exactly like this:

          TITLE: [Insert punchy title]
          DESCRIPTION: [Insert 2-sentence description]
          CATEGORY: [One of: Business, Sports, Politics, Entertainment, Technology, Education, Opinion]
          TAGS: [tag1, tag2, tag3]
          IMAGE_KEYWORD: [Search term for Unsplash]
          BODY:
          [Write the full 1500-word article here using ## Headers. NO Title at start.]

          *** CONTENT RULES ***
          - 6 Distinct Sections (250 words each).
          - Go deep. No fluff.
          """

          api_key = os.environ.get("GEMINI_API_KEY")
          if not api_key: raise SystemExit("Missing GEMINI_API_KEY")

          # --- 5. CALL GEMINI (With Retry) ---
          url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent"
          headers = { "x-goog-api-key": api_key, "Content-Type": "application/json" }
          payload = { "contents": [{ "parts": [{ "text": spec_text }] }] }

          max_retries = 5
          full_text = ""
          
          for attempt in range(max_retries):
              try:
                  resp = requests.post(url, headers=headers, data=json.dumps(payload), timeout=120)
                  if resp.status_code == 200:
                      full_text = resp.json()["candidates"][0]["content"]["parts"][0]["text"]
                      break
                  elif resp.status_code in [429, 500, 502, 503, 504]:
                      print(f"âš ï¸ API Busy ({resp.status_code}). Retrying in 30s...")
                      time.sleep(30)
                  else:
                      print(f"âŒ Error {resp.status_code}: {resp.text[:200]}")
                      break
              except Exception as e:
                  print(f"âš ï¸ Network Error: {e}. Retrying...")
                  time.sleep(30)
          
          if not full_text:
              raise SystemExit("Failed to get content from Gemini.")

          # --- 6. PARSE RESPONSE (Robust Mode) ---
          parsed = {
              "TITLE": f"Daily {topic.capitalize()} Update",
              "DESCRIPTION": "Latest news update.",
              "CATEGORY": "Opinion",
              "TAGS": "news, update",
              "IMAGE_KEYWORD": topic,
              "BODY": ""
          }

          current_section = None
          lines = full_text.splitlines()

          for line in lines:
              # Clean line to handle **TITLE:** or TITLE:
              clean_line = line.strip().replace("**", "")
              
              if clean_line.startswith("TITLE:"):
                  parsed["TITLE"] = clean_line.replace("TITLE:", "").strip()
                  current_section = None
              elif clean_line.startswith("DESCRIPTION:"):
                  parsed["DESCRIPTION"] = clean_line.replace("DESCRIPTION:", "").strip()
                  current_section = None
              elif clean_line.startswith("CATEGORY:"):
                  parsed["CATEGORY"] = clean_line.replace("CATEGORY:", "").strip()
                  current_section = None
              elif clean_line.startswith("TAGS:"):
                  parsed["TAGS"] = clean_line.replace("TAGS:", "").strip()
                  current_section = None
              elif clean_line.startswith("IMAGE_KEYWORD:"):
                  parsed["IMAGE_KEYWORD"] = clean_line.replace("IMAGE_KEYWORD:", "").strip()
                  current_section = None
              elif clean_line.startswith("BODY:"):
                  current_section = "BODY"
                  continue
              elif current_section == "BODY":
                  parsed["BODY"] += line + "\n"

          # --- 7. ASSEMBLE FINAL FILE ---
          
          # Get Image
          print(f"ðŸ“· Fetching image for: {parsed['IMAGE_KEYWORD']}")
          image_url = get_real_image(parsed['IMAGE_KEYWORD'])

          # Create Slug
          slug = re.sub(r'[^a-z0-9-]', '-', parsed["TITLE"].lower())
          slug = re.sub(r'-+', '-', slug).strip('-')

          # Format Tags
          tag_list = [t.strip() for t in parsed["TAGS"].split(',')]
          tags_json = json.dumps(tag_list)

          # Final Content Assembly
          final_file = f"""---
          title: "{parsed['TITLE'].replace('"', "'")}"
          description: "{parsed['DESCRIPTION'].replace('"', "'")}"
          date: "{date_str}"
          author: "Jonathan Mwaniki"
          image: "{image_url}"
          imageCaption: "Image for {parsed['IMAGE_KEYWORD']}"
          imageAlt: "{parsed['IMAGE_KEYWORD']}"
          category: "{parsed['CATEGORY']}"
          tags: {tags_json}
          featured: true
          draft: false
          slug: "{slug}"
          ---

          # {parsed['TITLE']}

          {parsed['BODY']}

          <div class="article-meta">
            <p><strong>Published:</strong> {date_str}</p>
            <p><strong>Author:</strong> Jonathan Mwaniki</p>
            <p><strong>Tags:</strong> {parsed['TAGS']}</p>
          </div>
          """

          # Dedent to fix YAML spacing if needed, though MD ignores it mostly
          import textwrap
          final_file = textwrap.dedent(final_file).strip()

          # Write to disk
          out_dir = os.path.join(os.getcwd(), os.environ.get("POSTS_DIR", "src/content/posts"))
          os.makedirs(out_dir, exist_ok=True)
          
          with open(os.path.join(out_dir, f"{slug}.md"), "w", encoding="utf-8") as f:
              f.write(final_file)
          
          print(f"âœ… Success! Created {slug}.md")
          EOF

      - name: Commit and push article
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "content: publish daily article (${{ github.run_id }})"
          branch: ${{ env.DEFAULT_BRANCH }}
          file_pattern: ${{ env.POSTS_DIR }}/*.md
          commit_user_name: "Content Bot"
          commit_user_email: "actions@github.com"
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN }}