name: Autonomous Content Publisher

on:
  schedule:
    - cron: '0 1 * * *'   # 4AM EAT (Tech -> Technology)
    - cron: '0 5 * * *'   # 8AM EAT (Finance -> Business)
    - cron: '0 10 * * *'  # 1PM EAT (Int. Politics -> Politics)
    - cron: '0 12 * * *'  # 3PM EAT (Kenyan Social -> Entertainment/Opinion)
  workflow_dispatch:
    inputs:
      manual_topic:
        description: 'Force a topic (optional)'
        required: false
        default: ''

permissions:
  contents: write

env:
  DEFAULT_BRANCH: main
  POSTS_DIR: src/content/posts

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ env.DEFAULT_BRANCH }}
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Generate article with Gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          MANUAL_TOPIC: ${{ inputs.manual_topic }}
        run: |
          python << 'EOF'
          import os, json, datetime, requests, re, random, time

          date_str = datetime.datetime.utcnow().date().strftime("%Y-%m-%d")
          current_hour_utc = datetime.datetime.utcnow().hour
          
          # --- HELPER: Fetch Real Photo from Unsplash ---
          def get_real_image(query):
              access_key = os.environ.get("UNSPLASH_ACCESS_KEY")
              # FALLBACK 1: If key is missing, use Abstract AI (No Humans)
              if not access_key:
                  print("âš ï¸ No Unsplash Key found. Using Safe AI fallback.")
                  safe_query = query.replace(" ", "-")
                  return f"https://image.pollinations.ai/prompt/minimalist-abstract-3d-render-of-{safe_query}-no-humans-cinematic-lighting?width=1200&height=630&nologo=true"
              
              url = f"https://api.unsplash.com/photos/random?query={query}&orientation=landscape&client_id={access_key}"
              try:
                  resp = requests.get(url, timeout=10)
                  if resp.status_code == 200:
                      data = resp.json()
                      return data['urls']['regular']
                  else:
                      print(f"âš ï¸ Unsplash Error {resp.status_code}. Using fallback.")
              except Exception as e:
                  print(f"âš ï¸ Unsplash Connection Error: {e}")
              
              # FALLBACK 2: If Unsplash fails, use a safe generic image
              return "https://images.unsplash.com/photo-1504711434969-e33886168f5c?auto=format&fit=crop&w=1200"

          # --- 1. DETERMINE TOPIC ---
          manual_input = os.environ.get('MANUAL_TOPIC', '').strip()
          if manual_input:
              topic = manual_input
          else:
              # Time-based routing (UTC times map to EAT schedule)
              if current_hour_utc < 3: topic = 'tech'                # 4AM EAT
              elif current_hour_utc < 8: topic = 'finance'             # 8AM EAT
              elif current_hour_utc < 11: topic = 'international-politics' # 1PM EAT
              else: topic = 'kenyan-social'                            # 3PM EAT
          
          print(f"ðŸŽ¯ Selected Topic: {topic}")

          # --- 2. DYNAMIC HOOKS ---
          hooks = [
             "A Direct Question: Start immediately with a hard-hitting question.",
             "A Shocking Statistic: Start with a number that makes no sense and explain it.",
             "A Cynical Observation: Start by mocking a common belief.",
             "A Direct Attack: Start by calling out a specific group.",
             "A 'Scene from the Future': Describe a scenario as if it's already here."
          ]
          selected_hook = random.choice(hooks)

          # --- 3. TOPIC INSTRUCTIONS ---
          if topic == 'tech':
              focus_instruction = "IMPORTANT: Focus ONLY on GLOBAL EMERGING TECHNOLOGY (AI, Quantum, Space). NO Kenya mentions."
              angle_instruction = "Find a global tech breakthrough that feels dangerous."
          elif topic == 'finance':
              focus_instruction = "IMPORTANT: Focus on FINANCE. Anti-repetition: NO generic IMF stories."
              angle_instruction = "Find a story about money that they are hiding from the common person."
          else:
              focus_instruction = f"IMPORTANT: Focus on '{topic}'. Anti-repetition: NO generic corruption stories."
              angles = ["an ignored scandal", "a rising underdog story", "a policy failure", "a controversial trend"]
              angle_instruction = f"TODAY'S ANGLE: Find a story about {random.choice(angles)}."

          # --- 4. CONSTRUCT PROMPT ---
          spec_text = f"""
          You are an autonomous content agent for jonathanmwaniki.co.ke.

          {focus_instruction}
          {angle_instruction}

          OPENING STRATEGY:
          - **{selected_hook}**
          - ABSOLUTE BAN: Do not start with "I was sitting at...".

          *** CATEGORY RULES (STRICT) ***
          - The 'category' field in the YAML frontmatter MUST be exactly one of these 9 options:
            ["Business", "Sports", "Politics", "Entertainment", "Technology", "Education", "Opinion", "Relationships", "Lifestyle" "Fashion"]
          - Do NOT use the raw topic name (e.g. do not use 'kenyan-social' or 'finance').
          - INTELLIGENTLY MAP the topic:
            - If topic is 'finance' -> use 'Business'.
            - If topic is 'tech' -> use 'Technology'.
            - If topic is 'international-politics' -> use 'Politics'.
            - If topic is Manual (e.g. "Teachers Strike") -> classify it correctly (e.g. "Education").

          *** LENGTH & STRUCTURE STRATEGY ***
          - The article MUST follow this EXACT sequential order:
            1. **YAML Frontmatter**
            2. **H1 Title**
            3. **Introduction** (2-3 paragraphs)
            4. **6 DISTINCT SECTIONS** (Use ## Headers). Each section must be 250 words deep.
            5. **FINAL ELEMENT:** The HTML `<div class="article-meta">` block.

          *** IMAGE STRATEGY ***
          - Provide a "Search Keyword" for a stock photo site on Line 2. (e.g., "coffee beans sack")

          *** CRITICAL OUTPUT FORMAT ***
          Line 1: A unique, SEO-optimized, lowercase-kebab-case slug.
          Line 2: IMAGE_KEYWORD: [Insert 2-3 word search term for Unsplash]
          Line 3: The start of the YAML frontmatter (---).

          1) YAML FRONTMATTER (starts on Line 3):
          ---
          title: "Title"
          description: "Description"
          date: "{date_str}"
          author: "Jonathan Mwaniki"
          image: "IMAGE_URL_PLACEHOLDER"
          imageCaption: "Caption"
          imageAlt: "Alt text"
          category: "SELECT_ONE_FROM_ALLOWED_LIST"
          tags: ["tag1", "tag2"]
          featured: true
          draft: false
          ---

          2) BODY STRUCTURE:
          # EXACT TITLE
          (Content follows...)

          (AT THE VERY END):
          <div class="article-meta">
            <p><strong>Published:</strong> {date_str}</p>
            <p><strong>Author:</strong> Jonathan Mwaniki</p>
            <p><strong>Tags:</strong> tag1, tag2</p>
          </div>
          """

          api_key = os.environ.get("GEMINI_API_KEY")
          if not api_key: raise SystemExit("Missing GEMINI_API_KEY")

          url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent"
          headers = { "x-goog-api-key": api_key, "Content-Type": "application/json" }
          payload = { "contents": [{ "parts": [{ "text": spec_text }] }] }

          # --- 5. ROBUST RETRY LOGIC ---
          max_retries = 5
          for attempt in range(max_retries):
              try:
                  resp = requests.post(url, headers=headers, data=json.dumps(payload), timeout=120)
                  if resp.status_code == 200: break
                  elif resp.status_code in [429, 500, 502, 503, 504]:
                      print(f"âš ï¸ API Busy/Error ({resp.status_code}). Retrying in 30s...")
                      time.sleep(30)
                  else: raise SystemExit(f"Gemini API Error {resp.status_code}: {resp.text[:500]}")
              except requests.exceptions.RequestException as e:
                  print(f"âš ï¸ Network Error: {e}. Retrying in 30s...")
                  time.sleep(30)
          else: raise SystemExit("Failed to generate content after multiple retries.")

          data = resp.json()
          try:
              full_text = data["candidates"][0]["content"]["parts"][0]["text"].strip()
          except Exception:
              raise SystemExit(f"Unexpected Gemini response: {json.dumps(data)[:800]}")

          # --- 6. PARSE OUTPUT ---
          lines = full_text.split('\n')
          
          slug = f"{topic}-story-{date_str}"
          image_keyword = topic
          content_start_index = 0

          if len(lines) > 2:
              raw_slug = lines[0].strip()
              slug = re.sub(r'[^a-z0-9-]', '', raw_slug.lower()) or slug
              if "IMAGE_KEYWORD:" in lines[1]:
                  image_keyword = lines[1].replace("IMAGE_KEYWORD:", "").strip()
                  content_start_index = 2
              else: content_start_index = 1
          
          print(f"ðŸ“· Fetching photo for: {image_keyword}")
          real_image_url = get_real_image(image_keyword)
          
          content_lines = lines[content_start_index:]
          full_content = "\n".join(content_lines)
          
          # --- 7. CLEANING ---
          final_content = full_content.replace("IMAGE_URL_PLACEHOLDER", real_image_url)
          final_content = final_content.replace(" â€” ", ", ").replace("â€”", ", ").replace(" â€“ ", ", ")
          final_content = final_content.replace(" ,", ",").replace(",,", ",")

          out_dir = os.path.join(os.getcwd(), os.environ.get("POSTS_DIR", "src/content/posts"))
          os.makedirs(out_dir, exist_ok=True)
          with open(os.path.join(out_dir, f"{slug}.md"), "w", encoding="utf-8") as f:
            f.write(final_content)

          print(f"âœ… Article written to {slug}.md")
          EOF

      - name: Commit and push article
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "content: publish daily article (${{ github.run_id }})"
          branch: ${{ env.DEFAULT_BRANCH }}
          file_pattern: ${{ env.POSTS_DIR }}/*.md
          commit_user_name: "Content Bot"
          commit_user_email: "actions@github.com"
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN }}