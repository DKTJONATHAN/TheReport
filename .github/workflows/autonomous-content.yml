name: Autonomous Real-Time Publisher

on:
  schedule:
    - cron: '0 1,6,10,15 * * *' # 4 AM, 9 AM, 1 PM, 6 PM EAT
  workflow_dispatch:
    inputs:
      manual_topic:
        description: 'Hard-hitting topic override'
        required: false

permissions:
  contents: write

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Research and Fearless Content Generation
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          MANUAL_TOPIC: ${{ github.event.inputs.manual_topic }}
          POSTS_DIR: src/content/posts
        run: |
          python << 'EOF'
          import os, json, datetime, requests, re, random, time

          # --- DYNAMIC DATE (NO STUPID HARDCODING) ---
          now = datetime.datetime.utcnow()
          date_str = now.strftime('%Y-%m-%d')
          human_date = now.strftime('%B %d, %Y')
          
          def call_gemini(prompt, use_search=False, temp=0.9):
              api_key = os.environ.get("GEMINI_API_KEY")
              # Using Gemini 3 Flash Preview as requested
              url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key={api_key}"
              
              payload = {
                  "contents": [{"parts": [{"text": prompt}]}],
                  "tools": [{"google_search_retrieval": {}}] if use_search else [],
                  "generationConfig": {"temperature": temp, "maxOutputTokens": 8192},
                  "safetySettings": [
                      {"category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE"},
                      {"category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE"},
                      {"category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE"},
                      {"category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE"}
                  ]
              }
              try:
                  resp = requests.post(url, json=payload, timeout=240)
                  data = resp.json()
                  if "candidates" in data and data["candidates"][0]["content"]["parts"]:
                      return data["candidates"][0]["content"]["parts"][0]["text"]
                  print(f"API Refusal/Error: {json.dumps(data, indent=2)}")
                  return None
              except Exception as e:
                  print(f"Request Failed: {e}")
                  return None

          # --- 1. RESEARCH PASS (STOPPING HALLUCINATIONS) ---
          topic_map = ["Kenyan Politics Scandals", "Global Tech Tyranny", "FKF Premier League Dirty Truths", "Athletics Doping Realities"]
          topic = os.environ.get('MANUAL_TOPIC') or random.choice(topic_map)
          
          scout_prompt = f"Today is {human_date}. Search for the 3 most controversial, trending news items about {topic}. Verify if the people involved are ALIVE and in POWER as of today. Do not use data from before 2025."
          research = call_gemini(scout_prompt, use_search=True)
          if not research: 
              print("Failed to gather research. Exiting.")
              exit(1)

          # --- 2. BOLD ARTICLE GENERATION ---
          gen_prompt = f"""
          TODAY: {human_date} | RESEARCH: {research}
          Write a 1500-word, high-SEO, unapologetic article for jonathanmwaniki.co.ke.
          
          STYLE: 
          - Fearless: Mention names, call out the bullshit. 
          - Unfiltered: Use vulgarity or rough language if it hits harder. 
          - Human: Use Sheng (slang), sentence fragments, and bias. No 'pivotal' or 'tapestry'.
          
          FORMAT:
          TITLE: [Competitive Keyword Headline]
          DESCRIPTION: [SEO summary]
          IMAGE_KEYWORD: [Cinematic Prompt]
          BODY: [Full Article Content]
          """
          raw_article = call_gemini(gen_prompt, temp=1.0)
          if not raw_article: exit(1)

          # --- 3. THE HUMANIZER LOOP ---
          human_test = f"Evaluate this article. If it sounds like a robot, rewrite it to be angry, human, and biased. Use Kenyan context and Sheng. ARTICLE: {raw_article}"
          final_text = call_gemini(human_test, temp=1.0) or raw_article

          # --- 4. PARSING & COMMIT ---
          title_match = re.search(r"TITLE:\s*(.*)", final_text)
          raw_title = title_match.group(1).strip() if title_match else "Savage News"
          
          # FIX: Clean the title outside the f-string to avoid backslash error
          clean_title = raw_title.replace('"', '')
          slug = re.sub(r'[^a-z0-9-]', '-', clean_title.lower()).strip('-')
          
          # Extract body and description
          desc_match = re.search(r"DESCRIPTION:\s*(.*)", final_text)
          clean_desc = desc_match.group(1).strip().replace('"', '') if desc_match else ""
          
          body_parts = final_text.split("BODY:")
          body = body_parts[-1].strip() if len(body_parts) > 1 else final_text

          # Construct Markdown
          final_md = (
              f"---\n"
              f"title: \"{clean_title}\"\n"
              f"description: \"{clean_desc}\"\n"
              f"date: \"{date_str}\"\n"
              f"featured: true\n"
              f"---\n\n"
              f"{body}"
          )
          
          posts_dir = os.environ.get('POSTS_DIR', 'src/content/posts')
          os.makedirs(posts_dir, exist_ok=True)
          with open(f"{posts_dir}/{slug}.md", "w") as f:
              f.write(final_md)
          EOF

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "content: grounded autonomous update [${{ github.run_id }}]"