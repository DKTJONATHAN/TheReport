name: Autonomous Real-Time Publisher

on:
  schedule:
    - cron: '0 1,6,10,15 * * *' # Optimized to run 4 times daily
  workflow_dispatch:
    inputs:
      manual_topic:
        description: 'Force a topic'
        required: false

permissions:
  contents: write

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Research and Generate
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          MANUAL_TOPIC: ${{ github.event.inputs.manual_topic }}
        run: |
          python << 'EOF'
          import os, json, datetime, requests, re, random, time

          # --- DYNAMIC DATE FIX ---
          # This ensures that even in 2027, it knows today's real date.
          now = datetime.datetime.utcnow()
          date_str = now.strftime('%Y-%m-%d')
          human_date = now.strftime('%B %d, %Y')
          
          manual_input = os.environ.get('MANUAL_TOPIC', '').strip()

          def call_gemini(prompt, use_search=False):
              api_key = os.environ.get("GEMINI_API_KEY")
              # Using Gemini 2.0 for superior grounding
              url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key={api_key}"
              
              payload = {
                  "contents": [{"parts": [{"text": prompt}]}],
                  "tools": [{"google_search_retrieval": {}}] if use_search else [],
                  "generationConfig": {"temperature": 1.0},
                  "safetySettings": [{"category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE"}]
              }
              try:
                  resp = requests.post(url, json=payload, timeout=240)
                  return resp.json()["candidates"][0]["content"]["parts"][0]["text"]
              except Exception as e: 
                  print(f"Error: {e}")
                  return None

          # --- 1. REAL-TIME FACT SCOUTING ---
          topic_pool = ["Kenyan Politics", "Big Tech War", "FKF Premier League", "Global Scandals"]
          base_topic = manual_input if manual_input else random.choice(topic_pool)
          
          # We force a search for the "Status" of players to avoid 2016 data.
          research_prompt = f"Perform a deep search for the most controversial news regarding {base_topic} specifically on {human_date}. Verify who is currently in power, who is deceased, and what the actual scores or prices are today."
          
          print(f"Fact-Scouting for {human_date}...")
          grounding_data = call_gemini(research_prompt, use_search=True)

          if not grounding_data:
              print("Search failed. Exiting to avoid hallucinations.")
              exit(1)

          # --- 2. FEARLESS WRITING ---
          write_prompt = f"""
          TODAY'S DATE: {human_date}
          VERIFIED DATA: {grounding_data}

          Write a 1500-word SEO article for jonathanmwaniki.co.ke. 
          
          STRICT RULES:
          1. NO GHOSTS: If a person is deceased in the verified data, write about their legacy or the vacuum they left. Do not put them in office.
          2. VULGAR & BOLD: Be unapologetic. Use names. Call out corruption or failure using strong language.
          3. HUMAN SOUND: Use sentence fragments. Use Kenyan Sheng. No 'pivotal' or 'landscape'.
          4. FORMAT: 
             TITLE: [Headline]
             DESCRIPTION: [SEO Meta]
             BODY: [Article Content]
          """

          raw_article = call_gemini(write_prompt)

          # --- 3. HUMANIZER PASS ---
          final_content = call_gemini(f"Rewrite this to sound like a pissed-off human expert in Nairobi. Make it messy, brilliant, and aggressive. Remove the AI smell.\n\n{raw_article}") or raw_article

          # --- 4. SAVE ---
          parsed_title = re.search(r"TITLE:\s*(.*)", final_content)
          title = parsed_title.group(1).strip() if parsed_title else "New Article"
          slug = re.sub(r'[^a-z0-9-]', '-', title.lower()).strip('-')
          
          # Strip formatting junk
          body = final_content.split("BODY:")[-1].strip()

          final_md = f"---\ntitle: \"{title}\"\ndate: \"{date_str}\"\n---\n\n{body}"
          
          os.makedirs(os.environ['POSTS_DIR'], exist_ok=True)
          with open(f"{os.environ['POSTS_DIR']}/{slug}.md", "w") as f:
              f.write(final_md)
          EOF

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Real-time Grounded Content: ${{ github.run_id }}"