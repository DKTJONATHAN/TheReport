---
import { getCollection } from 'astro:content';

// 1. DATA FETCHING
// Filter out drafts to prevent broken links in search/ticker
const allPosts = await getCollection('posts');
const publicPosts = allPosts.filter(p => !p.data.draft);

const categories = ['Politics', 'Business', 'Sports', 'Lifestyle', 'Opinion'];

// 2. SEARCH INDEX (Lightweight payload)
const serializedPosts = publicPosts.map(post => ({
  slug: post.slug,
  title: post.data.title,
  category: post.data.category || 'News',
  image: post.data.image || '/default-image.jpg',
  date: new Date(post.data.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
}));

// 3. TRENDING LOGIC
const sortedPosts = publicPosts.sort((a, b) => new Date(b.data.date).valueOf() - new Date(a.data.date).valueOf());
const top5 = sortedPosts.slice(0, 5);

// 4. INFINITE LOOP PREP
// We duplicate the array to create a seamless loop effect (A + A)
const tickerStories = [...top5, ...top5]; 

const navItems = [
  { href: '/', text: 'Home' },
  { href: '/category/politics', text: 'Politics' },
  { href: '/category/business', text: 'Business' },
  { href: '/category/sports', text: 'Sports' },
  { href: '/category/lifestyle', text: 'Lifestyle' },
  { href: '/about', text: 'About' },
];

const companyLinks = [
  { href: '/about', text: 'About Us' },
  { href: '/contact', text: 'Contact Desk' },
  { href: '/privacy', text: 'Privacy Policy' },
  { href: '/terms', text: 'Terms of Service' },
];

const today = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
---

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

<header class="master-header" id="master-header">

  {/* --- UTILITY BAR --- */}
  <div class="utility-bar">
    <div class="utility-inner">
      <div class="date-display">{today}</div>

      {/* THE RED PILL TICKER */}
      <div class="ticker-red-pill">
        <span class="ticker-badge">TRENDING</span>
        <div class="ticker-mask">
          {tickerStories.length > 0 ? (
            <div class="ticker-track">
              {tickerStories.map((story, index) => (
                <div class="ticker-group" key={index}>
                  <a href={`/posts/${story.slug}`} class="ticker-link">
                    <span class="ticker-title">{story.data.title}</span>
                    <span class="ticker-sep">—</span>
                    <span class="ticker-desc">{story.data.description}</span>
                  </a>
                  <span class="ticker-dot">•</span>
                </div>
              ))}
            </div>
          ) : (
            <div class="ticker-no-data">Welcome to The Mwaniki Report</div>
          )}
        </div>
      </div>

    </div>
  </div>

  {/* --- MAIN HEADER --- */}
  <div class="main-header">
    <div class="header-content">
      <button class="icon-btn menu-btn" id="menu-trigger" aria-label="Menu">
        <span class="menu-line top"></span>
        <span class="menu-line mid"></span>
        <span class="menu-line bot"></span>
      </button>

      <a href="/" class="brand-center">
        <div class="brand-stack">
          <span class="brand-top">The</span>
          <h1 class="brand-main"><span class="highlight">Mwaniki</span> Report</h1>
        </div>
      </a>

      <button class="icon-btn search-btn" id="search-trigger" aria-label="Search">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
      </button>
    </div>
  </div>

  {/* --- STICKY NAV (Desktop Only) --- */}
  <nav class="sticky-nav" id="sticky-nav">
    <ul class="nav-list">
      {navItems.map(link => (
        <li><a href={link.href} class="nav-link">{link.text}</a></li>
      ))}
    </ul>
    <div class="scroll-progress" id="scroll-progress"></div>
  </nav>

  {/* --- OVERLAYS --- */}
  
  {/* 1. SEARCH OVERLAY */}
  <div class="fs-search" id="fs-search" aria-hidden="true">
    <button class="fs-close" id="fs-close" aria-label="Close Search">Close ✕</button>
    <div class="fs-container">
      <h3 class="fs-label">What are you looking for?</h3>
      <input type="text" class="fs-input" id="fs-input" placeholder="Type keywords..." autocomplete="off" />
      <div class="fs-results" id="fs-results"></div>
    </div>
  </div>

  {/* 2. MOBILE MENU DRAWER (New Design) */}
  <div class="mm-overlay" id="mobile-menu" aria-hidden="true">
    <div class="mm-backdrop" id="mm-backdrop"></div>

    <div class="mm-panel">
      
      <div class="mm-header-row">
        <span class="mm-brand">Menu</span>
        <button class="mm-close-btn" id="mm-close" aria-label="Close Menu">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
      </div>

      <div class="mm-scroll-content">
        <nav class="mm-nav-group">
          <h4 class="mm-label">Sections</h4>
          {categories.map(c => (
            <a href={`/category/${c.toLowerCase()}`} class="mm-link-serif">
              {c}
              <svg class="arrow" viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
            </a>
          ))}
        </nav>

        <nav class="mm-nav-group">
          <h4 class="mm-label">Company</h4>
          {companyLinks.map(link => (
            <a href={link.href} class="mm-link-sans">{link.text}</a>
          ))}
        </nav>
      </div>

      <div class="mm-footer">
        <div class="mm-socials">
          <a href="#" aria-label="Twitter">X</a>
          <a href="#" aria-label="Facebook">FB</a>
          <a href="#" aria-label="LinkedIn">LI</a>
        </div>
        <div class="mm-copy">© 2026 The Mwaniki Report</div>
      </div>
    </div>
  </div>

</header>

<style>
  :root {
    --black: #111;
    --white: #fff;
    --accent: #dc2626;
    --border: #e5e5e5;
    --serif: 'Playfair Display', serif;
    --sans: 'Inter', sans-serif;
  }
  * { box-sizing: border-box; }

  .master-header { background: var(--white); color: var(--black); position: relative; z-index: 900; }

  /* UTILITY BAR */
  .utility-bar {
    border-bottom: 1px solid var(--border);
    font-family: var(--sans);
    font-size: 0.75rem;
    height: 48px;
    background: #ffffff;
    display: flex; align-items: center;
  }
  .utility-inner {
    width: 100%; max-width: 1240px; margin: 0 auto;
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 1.5rem; gap: 1rem;
  }
  .date-display {
    color: #444; font-weight: 700; text-transform: uppercase;
    font-size: 0.7rem; letter-spacing: 0.5px; white-space: nowrap;
  }

  /* TICKER PILL (Optimized) */
  .ticker-red-pill {
    flex: 1;
    background: var(--accent);
    color: white;
    height: 32px;
    border-radius: 99px;
    display: flex; align-items: center;
    padding: 0 4px;
    overflow: hidden; 
    box-shadow: 0 2px 10px rgba(220, 38, 38, 0.2);
    max-width: 800px;
    margin-left: auto;
    position: relative; 
  }
  
  /* Pause animation when hovering anywhere on the pill */
  .ticker-red-pill:hover .ticker-track {
    animation-play-state: paused;
  }

  .ticker-badge {
    background: rgba(0,0,0,0.2);
    color: white;
    font-weight: 800; font-size: 0.65rem;
    padding: 4px 10px; border-radius: 99px;
    white-space: nowrap; margin-right: 10px; flex-shrink: 0;
  }

  .ticker-mask {
    flex: 1;
    overflow: hidden;
    position: relative; height: 100%;
    display: flex; align-items: center;
    /* Gradient mask to fade edges */
    mask-image: linear-gradient(to right, transparent, black 15px, black 95%, transparent);
    -webkit-mask-image: linear-gradient(to right, transparent, black 15px, black 95%, transparent);
  }

  .ticker-track {
    display: flex;
    align-items: center;
    width: max-content; /* Ensures container grows to fit content */
    animation: marquee 80s linear infinite; 
    will-change: transform;
  }

  .ticker-group {
    display: flex;
    align-items: center;
    white-space: nowrap;
  }

  .ticker-link {
    display: flex; align-items: center;
    color: white; text-decoration: none;
  }
  .ticker-link:hover .ticker-title { text-decoration: underline; }

  .ticker-title { font-weight: 700; font-size: 0.8rem; margin-right: 8px; }
  .ticker-sep { opacity: 0.6; margin-right: 8px; }
  .ticker-desc { font-weight: 400; opacity: 0.9; font-size: 0.8rem; font-style: italic; }

  .ticker-dot {
    margin: 0 2rem; 
    font-size: 1.2rem; line-height: 0;
    opacity: 0.5; color: #fff;
  }

  @keyframes marquee {
    0% { transform: translateX(0); }
    100% { transform: translateX(-50%); } 
  }

  /* MAIN HEADER */
  .main-header { padding: 1.5rem 0; background: var(--white); z-index: 2; position: relative; }
  .header-content {
    max-width: 1240px; margin: 0 auto; display: grid;
    grid-template-columns: 50px 1fr 50px; align-items: center; padding: 0 1.5rem;
  }
  
  .icon-btn {
    background: none; border: none; cursor: pointer; width: 44px; height: 44px;
    display: flex; align-items: center; justify-content: center; border-radius: 50%;
    transition: background 0.2s; color: var(--black);
  }
  .icon-btn:hover { background: #f0f0f0; }

  /* MENU ICON */
  .menu-btn { flex-direction: column; gap: 5px; }
  .menu-line { width: 22px; height: 2px; background: currentColor; transition: 0.3s; }
  .menu-active .top { transform: rotate(45deg) translate(5px, 5px); }
  .menu-active .mid { opacity: 0; }
  .menu-active .bot { transform: rotate(-45deg) translate(5px, -5px); }

  /* BRAND */
  .brand-center { text-align: center; text-decoration: none; color: var(--black); }
  .brand-stack { display: flex; flex-direction: column; align-items: center; line-height: 0.8; }
  .brand-top { font-family: var(--sans); text-transform: uppercase; font-size: 0.7rem; letter-spacing: 3px; font-weight: 700; margin-bottom: 5px; }
  .brand-main { font-family: var(--serif); font-size: 2.5rem; font-weight: 900; margin: 0; letter-spacing: -1px; white-space: nowrap; }
  .highlight { color: var(--accent); }

  /* STICKY NAV */
  .sticky-nav {
    border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);
    position: sticky; top: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
    z-index: 800; transition: transform 0.3s;
  }
  .nav-up { transform: translateY(-100%); }
  .nav-list { display: none; justify-content: center; gap: 2.5rem; list-style: none; margin: 0; padding: 0.8rem 0; }
  .nav-link { font-family: var(--sans); text-transform: uppercase; font-size: 0.75rem; font-weight: 700; letter-spacing: 1px; color: var(--black); text-decoration: none; position: relative; padding-bottom: 5px; }
  .nav-link::after { content: ''; position: absolute; bottom: 0; left: 0; width: 0; height: 2px; background: var(--accent); transition: width 0.3s; }
  .nav-link:hover::after { width: 100%; }

  /* SCROLL BAR */
  .scroll-progress { height: 2px; background: var(--accent); width: 0%; position: absolute; bottom: -1px; left: 0; transition: width 0.1s; }

  /* SEARCH OVERLAY */
  .fs-search { position: fixed; inset: 0; background: rgba(255,255,255,0.98); z-index: 2000; display: flex; flex-direction: column; align-items: center; padding-top: 15vh; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
  .fs-search.active { opacity: 1; pointer-events: all; }
  .fs-close { position: absolute; top: 2rem; right: 2rem; background: none; border: none; font-family: var(--sans); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; padding: 1rem; font-size: 0.9rem; }
  
  .fs-container { width: 100%; max-width: 800px; padding: 0 1.5rem; }
  .fs-label { font-family: var(--serif); font-size: 1.5rem; margin-bottom: 1rem; color: #555; font-weight: 400; }
  .fs-input { width: 100%; border: none; border-bottom: 2px solid #ddd; font-size: 3rem; font-family: var(--serif); font-weight: 700; padding: 0.5rem 0; background: transparent; outline: none; color: var(--black); }
  .fs-input:focus { border-color: var(--accent); }
  .fs-results { margin-top: 3rem; max-height: 50vh; overflow-y: auto; }
  
  .fs-tags { display: flex; gap: 0.8rem; flex-wrap: wrap; margin-top: 1rem; }
  .fs-tag { padding: 0.5rem 1.2rem; border: 1px solid #ddd; border-radius: 50px; text-decoration: none; color: var(--black); font-family: var(--sans); font-size: 0.85rem; transition: 0.2s; }
  .fs-tag:hover { background: var(--black); color: var(--white); border-color: var(--black); }

  .search-hit { display: flex; align-items: center; gap: 1.5rem; padding: 1rem 0; border-bottom: 1px solid #eee; text-decoration: none; color: var(--black); animation: slideUp 0.3s ease-out forwards; }
  .search-hit:hover { background: #fafafa; }
  .search-hit img { width: 80px; height: 80px; object-fit: cover; border-radius: 4px; }
  .search-hit h4 { font-family: var(--serif); font-size: 1.4rem; margin: 0; line-height: 1.2; }
  .search-hit span { font-family: var(--sans); font-size: 0.75rem; color: var(--accent); text-transform: uppercase; font-weight: 700; display: block; margin-bottom: 5px; }
  
  @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

  /* --- MOBILE MENU OVERLAY (New Design) --- */
  .mm-overlay {
    position: fixed; inset: 0; z-index: 1000;
    display: flex; 
    visibility: hidden; transition: visibility 0.4s;
  }
  .mm-overlay.open { visibility: visible; }

  .mm-backdrop {
    position: absolute; inset: 0;
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(4px);
    opacity: 0; transition: opacity 0.4s ease;
  }
  .mm-overlay.open .mm-backdrop { opacity: 1; }

  .mm-panel {
    position: relative;
    width: 85%; max-width: 360px; height: 100%;
    background: #fff;
    transform: translateX(-100%);
    transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    display: flex; flex-direction: column;
    box-shadow: 10px 0 25px rgba(0,0,0,0.1);
  }
  .mm-overlay.open .mm-panel { transform: translateX(0); }

  .mm-header-row {
    display: flex; justify-content: space-between; align-items: center;
    padding: 1.5rem 1.5rem 1rem;
  }
  .mm-brand { font-family: var(--sans); font-weight: 800; text-transform: uppercase; letter-spacing: 1px; font-size: 0.8rem; color: #999; }
  .mm-close-btn { background: none; border: none; cursor: pointer; color: var(--black); padding: 5px; }

  .mm-scroll-content {
    flex: 1; overflow-y: auto; padding: 0 1.5rem;
    scrollbar-width: none; -ms-overflow-style: none;
  }
  .mm-scroll-content::-webkit-scrollbar { display: none; }

  .mm-nav-group { margin-bottom: 2.5rem; }
  .mm-label { font-family: var(--sans); font-size: 0.7rem; text-transform: uppercase; color: #aaa; letter-spacing: 1px; margin-bottom: 1rem; }

  .mm-link-serif {
    display: flex; justify-content: space-between; align-items: center;
    font-family: var(--serif); font-size: 1.5rem; font-weight: 700;
    color: var(--black); text-decoration: none;
    padding: 0.6rem 0; border-bottom: 1px solid #f4f4f4;
    transition: color 0.2s;
  }
  .mm-link-serif .arrow { opacity: 0; transform: translateX(-10px); transition: 0.2s; color: var(--accent); }
  .mm-link-serif:hover { color: var(--accent); }
  .mm-link-serif:hover .arrow { opacity: 1; transform: translateX(0); }

  .mm-link-sans {
    display: block; font-family: var(--sans); font-size: 1rem; font-weight: 500;
    color: #555; text-decoration: none; padding: 0.5rem 0;
    transition: color 0.2s;
  }
  .mm-link-sans:hover { color: var(--black); }

  .mm-footer {
    padding: 1.5rem; background: #f9f9f9; border-top: 1px solid #eee;
  }
  .mm-socials { display: flex; gap: 1rem; margin-bottom: 0.5rem; }
  .mm-socials a { font-family: var(--sans); font-weight: 700; font-size: 0.8rem; text-decoration: none; color: var(--black); }
  .mm-copy { font-family: var(--sans); font-size: 0.7rem; color: #aaa; }

  /* MOBILE TWEAKS */
  @media(max-width: 900px) {
    .nav-list { display: none; }
  }
  @media(max-width: 768px) { 
    .date-display { display: none; } 
    .ticker-red-pill { margin: 0; width: 100%; border-radius: 0; }
    .ticker-badge { padding: 4px 6px; font-size: 0.6rem; }
  }
  @media(max-width: 480px) { 
    .brand-main { font-size: 1.8rem; } 
    .fs-input { font-size: 1.8rem; }
  }
</style>

<script is:inline define:vars={{posts: serializedPosts}}>
  function initHeader() {
    const menuTrigger = document.getElementById('menu-trigger');
    
    // New Mobile Menu Elements
    const mobileMenu = document.getElementById('mobile-menu');
    const mmBackdrop = document.getElementById('mm-backdrop');
    const mmClose = document.getElementById('mm-close');
    
    const stickyNav = document.getElementById('sticky-nav');
    const searchTrigger = document.getElementById('search-trigger');
    const fsSearch = document.getElementById('fs-search');
    const fsClose = document.getElementById('fs-close');
    const fsInput = document.getElementById('fs-input');
    const fsResults = document.getElementById('fs-results');
    const progressBar = document.getElementById('scroll-progress');

    // Safety check: Ensure elements exist before adding listeners
    if (!menuTrigger || !searchTrigger) return;

    // MENU LOGIC
    let isMenuOpen = false;
    const toggleMenu = () => {
      isMenuOpen = !isMenuOpen;
      mobileMenu.classList.toggle('open');
      menuTrigger.classList.toggle('menu-active');
      document.body.style.overflow = isMenuOpen ? 'hidden' : '';
      mobileMenu.setAttribute('aria-hidden', !isMenuOpen);
    };

    menuTrigger.onclick = toggleMenu;
    if(mmBackdrop) mmBackdrop.onclick = toggleMenu;
    if(mmClose) mmClose.onclick = toggleMenu;

    // SEARCH OPEN
    searchTrigger.onclick = () => {
      fsSearch.classList.add('active');
      fsSearch.setAttribute('aria-hidden', 'false');
      setTimeout(() => fsInput.focus(), 100);
      document.body.style.overflow = 'hidden';
    };

    // SEARCH CLOSE
    const closeSearch = () => {
      fsSearch.classList.remove('active');
      fsSearch.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
      if (isMenuOpen) document.body.style.overflow = 'hidden'; // Keep locked if menu is open
    };
    fsClose.onclick = closeSearch;

    // SEARCH FILTERING
    fsInput.oninput = (e) => {
      const term = e.target.value.toLowerCase().trim();
      
      if(term.length < 2) {
         fsResults.innerHTML = `
          <div class="fs-empty">
            <span style="display:block; font-family:'Inter'; font-size:0.8rem; text-transform:uppercase; color:#888; margin-bottom:1rem;">Trending now:</span>
            <div class="fs-tags">
               <a href="/category/politics" class="fs-tag">Politics</a>
               <a href="/category/business" class="fs-tag">Business</a>
               <a href="/category/sports" class="fs-tag">Sports</a>
            </div>
          </div>`;
         return;
      }
      
      const hits = posts.filter(p => p.title.toLowerCase().includes(term)).slice(0, 5);
      
      if(hits.length === 0) {
        fsResults.innerHTML = `<div style="text-align:center; color:#999; margin-top:2rem;">No stories found for "${term}"</div>`;
      } else {
        fsResults.innerHTML = hits.map(h => `
          <a href="/posts/${h.slug}" class="search-hit">
             <img src="${h.image}" alt="">
             <div>
                <span>${h.category}</span>
                <h4>${h.title}</h4>
             </div>
          </a>
        `).join('');
      }
    };

    // SCROLL & STICKY
    let lastScroll = 0;
    window.onscroll = () => {
      const currentScroll = window.scrollY;
      
      // Progress Bar
      const totalHeight = document.documentElement.scrollHeight - window.innerHeight;
      const progress = (currentScroll / totalHeight) * 100;
      if(progressBar) progressBar.style.width = `${progress}%`;

      // Sticky Hide/Show
      if (currentScroll > 100 && currentScroll > lastScroll && !isMenuOpen) {
        stickyNav.classList.add('nav-up');
      } else {
        stickyNav.classList.remove('nav-up');
      }
      lastScroll = currentScroll;
    };

    // ESCAPE KEY CLOSE
    document.onkeydown = (e) => {
      if(e.key === 'Escape') {
        if (fsSearch.classList.contains('active')) closeSearch();
        if (isMenuOpen) toggleMenu();
      }
    };
  }

  // Initialize immediately
  initHeader();

  // Re-initialize on view transitions
  document.addEventListener('astro:after-swap', initHeader);
</script>