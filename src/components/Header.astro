---
import { getCollection } from 'astro:content';

// 1. DATA FETCHING
const posts = await getCollection('posts');
const categories = ['Politics', 'Business', 'Sports', 'Lifestyle', 'Opinion'];

// 2. SEARCH INDEX
const serializedPosts = posts.map(post => ({
  slug: post.slug,
  title: post.data.title,
  category: post.data.category || 'News',
  image: post.data.image || '/default-image.jpg',
  date: new Date(post.data.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
}));

// 3. TRENDING LOGIC (Modified to pick top 5)
const sortedPosts = posts.sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());
const trendingStories = sortedPosts.slice(0, 5); // Pick top 5 items

const navItems = [
  { href: '/', text: 'Home' },
  { href: '/category/politics', text: 'Politics' },
  { href: '/category/business', text: 'Business' },
  { href: '/category/sports', text: 'Sports' },
  { href: '/category/lifestyle', text: 'Lifestyle' },
  { href: '/about', text: 'About' },
];

const today = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
---

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

<header class="master-header" id="master-header">

  {/* --- 1. UTILITY BAR (Date & RED Ticker) --- */}
  <div class="utility-bar">
    <div class="utility-inner">
      <div class="date-display">{today}</div>

      {/* THE RED PILL TICKER */}
      <div class="ticker-red-pill">
        <span class="ticker-badge">TRENDING</span>
        <div class="ticker-mask">
          {trendingStories.length > 0 ? (
            <div class="ticker-track">
              {trendingStories.map((story) => (
                <span class="ticker-group">
                  <a href={`/posts/${story.slug}`} class="ticker-link">
                    <span class="ticker-title">{story.data.title}</span>
                    <span class="ticker-sep">—</span>
                    <span class="ticker-desc">{story.data.description}</span>
                  </a>
                  <span class="ticker-dot">•</span>
                </span>
              ))}
            </div>
          ) : (
            <div class="ticker-track">
              <span class="ticker-title">Welcome to The Mwaniki Report</span>
            </div>
          )}
        </div>
      </div>

    </div>
  </div>

  {/* --- 2. MAIN HEADER (Logo & Actions) --- */}
  <div class="main-header">
    <div class="header-content">

      {/* LEFT: Menu Trigger */}
      <button class="icon-btn menu-btn" id="menu-trigger" aria-label="Menu">
        <span class="menu-line top"></span>
        <span class="menu-line mid"></span>
        <span class="menu-line bot"></span>
      </button>

      {/* CENTER: Brand */}
      <a href="/" class="brand-center">
        <div class="brand-stack">
          <span class="brand-top">The</span>
          <h1 class="brand-main"><span class="highlight">Mwaniki</span> Report</h1>
        </div>
      </a>

      {/* RIGHT: Search */}
      <button class="icon-btn search-btn" id="search-trigger" aria-label="Search">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
      </button>

    </div>
  </div>

  {/* --- 3. NAVIGATION (Sticky) --- */}
  <nav class="sticky-nav" id="sticky-nav">
    <ul class="nav-list">
      {navItems.map(link => (
        <li><a href={link.href} class="nav-link">{link.text}</a></li>
      ))}
    </ul>
    <div class="scroll-progress" id="scroll-progress"></div>
  </nav>

  {/* --- FULLSCREEN SEARCH OVERLAY --- */}
  <div class="fs-search" id="fs-search">
    <button class="fs-close" id="fs-close">Close</button>
    <div class="fs-container">
      <h3 class="fs-label">What are you looking for?</h3>
      <input type="text" class="fs-input" id="fs-input" placeholder="Type keywords..." autocomplete="off" />

      <div class="fs-results" id="fs-results">
        {/* Empty State */}
        <div class="fs-empty">
          <span>Trending now:</span>
          <div class="fs-tags">
            {categories.map(c => <a href={`/category/${c.toLowerCase()}`} class="fs-tag">{c}</a>)}
          </div>
        </div>
      </div>
    </div>
  </div>

  {/* --- MOBILE MENU OVERLAY --- */}
  <div class="mobile-menu" id="mobile-menu">
    <div class="mm-content">
      <nav class="mm-nav">
        {navItems.map(link => (
          <a href={link.href} class="mm-link">{link.text}</a>
        ))}
        <div class="mm-cats">
            {categories.map(c => <a href={`/category/${c.toLowerCase()}`} class="mm-cat">#{c}</a>)}
        </div>
      </nav>
    </div>
  </div>

</header>

<style>
  :root {
    --black: #111;
    --white: #fff;
    --accent: #dc2626; /* Vivid Red */
    --accent-dark: #b91c1c;
    --gray: #f4f4f4;
    --border: #e5e5e5;
    --serif: 'Playfair Display', serif;
    --sans: 'Inter', sans-serif;
  }

  * { box-sizing: border-box; }

  .master-header {
    background: var(--white);
    color: var(--black);
    position: relative;
    z-index: 900;
  }

  /* --- 1. UTILITY BAR --- */
  .utility-bar {
    border-bottom: 1px solid var(--border);
    font-family: var(--sans);
    font-size: 0.75rem;
    height: 48px; /* Slightly taller for the pill */
    background: #ffffff;
    display: flex;
    align-items: center;
  }

  .utility-inner {
    width: 100%;
    max-width: 1240px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 1.5rem;
    gap: 1rem;
  }

  .date-display {
    color: #444;
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.7rem;
    letter-spacing: 0.5px;
    white-space: nowrap;
  }

  /* THE RED PILL CONTAINER */
  .ticker-red-pill {
    flex: 1;
    background: var(--accent);
    color: white;
    height: 32px;
    border-radius: 99px; /* Fully curved */
    display: flex;
    align-items: center;
    padding: 0 4px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(220, 38, 38, 0.2);
    max-width: 800px;
    margin-left: auto;
  }

  .ticker-badge {
    background: rgba(0,0,0,0.2);
    color: white;
    font-weight: 800;
    font-size: 0.65rem;
    padding: 4px 10px;
    border-radius: 99px;
    white-space: nowrap;
    margin-right: 10px;
    flex-shrink: 0;
  }

  .ticker-mask {
    flex: 1;
    overflow: hidden;
    position: relative;
    height: 100%;
    display: flex;
    align-items: center;
    mask-image: linear-gradient(to right, transparent, black 10px, black 95%, transparent);
  }

  /* UPDATED TICKER STYLES */
  .ticker-track {
    display: flex;
    align-items: center;
    white-space: nowrap;
    color: white;
    animation: marquee 40s linear infinite; /* Slowed down for readability of 5 items */
    padding-left: 0;
  }
  .ticker-track:hover { animation-play-state: paused; }

  .ticker-group {
    display: inline-flex;
    align-items: center;
  }

  .ticker-link {
    display: inline-flex;
    align-items: center;
    color: white;
    text-decoration: none;
  }
  .ticker-link:hover .ticker-title { text-decoration: underline; }

  .ticker-title { font-weight: 700; font-size: 0.8rem; margin-right: 8px; }
  .ticker-sep { opacity: 0.6; margin-right: 8px; }
  .ticker-desc { font-weight: 400; opacity: 0.9; font-size: 0.8rem; font-style: italic; }
  
  .ticker-dot {
    margin: 0 2rem; /* Spacing around the dot */
    font-size: 1.2rem;
    line-height: 0;
    opacity: 0.5;
    color: #fff;
  }

  @keyframes marquee {
    0% { transform: translateX(20%); }
    100% { transform: translateX(-200%); } /* Increased translate to scroll all items */
  }

  @media(max-width: 768px) { 
    .date-display { display: none; } 
    .ticker-red-pill { margin: 0; width: 100%; }
  }


  /* --- 2. MAIN HEADER --- */
  .main-header {
    padding: 1.5rem 0;
    background: var(--white);
    position: relative;
    z-index: 2;
  }

  .header-content {
    max-width: 1240px; margin: 0 auto;
    display: grid;
    grid-template-columns: 50px 1fr 50px;
    align-items: center;
    padding: 0 1.5rem;
  }

  .icon-btn {
    background: none; border: none; cursor: pointer;
    width: 44px; height: 44px;
    display: flex; align-items: center; justify-content: center;
    border-radius: 50%;
    transition: background 0.2s;
    color: var(--black);
  }
  .icon-btn:hover { background: #f0f0f0; }

  .menu-btn { flex-direction: column; gap: 5px; }
  .menu-line { width: 22px; height: 2px; background: currentColor; transition: 0.3s; }
  .menu-active .top { transform: rotate(45deg) translate(5px, 5px); }
  .menu-active .mid { opacity: 0; }
  .menu-active .bot { transform: rotate(-45deg) translate(5px, -5px); }

  .brand-center { text-align: center; text-decoration: none; color: var(--black); }
  .brand-stack { display: flex; flex-direction: column; align-items: center; line-height: 0.8; }
  .brand-top {
    font-family: var(--sans);
    text-transform: uppercase;
    font-size: 0.7rem;
    letter-spacing: 3px;
    font-weight: 700;
    margin-bottom: 5px;
  }
  .brand-main {
    font-family: var(--serif);
    font-size: 2.5rem;
    font-weight: 900;
    margin: 0;
    letter-spacing: -1px;
    white-space: nowrap;
  }
  .highlight { color: var(--accent); }

  @media(max-width: 480px) { .brand-main { font-size: 1.8rem; } }


  /* --- 3. STICKY NAV --- */
  .sticky-nav {
    border-top: 1px solid var(--border);
    border-bottom: 1px solid var(--border);
    position: sticky; top: 0;
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(10px);
    z-index: 800;
    transition: transform 0.3s;
  }
  .nav-up { transform: translateY(-100%); }

  .nav-list {
    display: none; 
    justify-content: center;
    gap: 2.5rem;
    list-style: none; margin: 0; padding: 0.8rem 0;
  }
  @media(min-width: 900px) { .nav-list { display: flex; } }

  .nav-link {
    font-family: var(--sans);
    text-transform: uppercase;
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 1px;
    color: var(--black);
    text-decoration: none;
    position: relative;
    padding-bottom: 5px;
  }
  .nav-link::after {
    content: ''; position: absolute; bottom: 0; left: 0; width: 0; height: 2px;
    background: var(--accent); transition: width 0.3s;
  }
  .nav-link:hover::after { width: 100%; }

  .scroll-progress { height: 2px; background: var(--accent); width: 0%; position: absolute; bottom: -1px; left: 0; transition: width 0.1s; }


  /* --- FULLSCREEN SEARCH --- */
  .fs-search {
    position: fixed; inset: 0;
    background: rgba(255,255,255,0.98);
    z-index: 2000;
    display: flex; flex-direction: column; align-items: center;
    padding-top: 15vh;
    opacity: 0; pointer-events: none;
    transition: opacity 0.3s;
  }
  .fs-search.active { opacity: 1; pointer-events: all; }

  .fs-close {
    position: absolute; top: 2rem; right: 2rem;
    background: none; border: none; font-family: var(--sans);
    font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
    cursor: pointer; padding: 1rem;
  }

  .fs-container { width: 100%; max-width: 800px; padding: 0 1.5rem; }
  .fs-label { font-family: var(--serif); font-size: 1.5rem; margin-bottom: 1rem; color: #555; font-weight: 400; }

  .fs-input {
    width: 100%; border: none; border-bottom: 2px solid #ddd;
    font-size: 3rem; font-family: var(--serif); font-weight: 700;
    padding: 0.5rem 0; background: transparent; outline: none;
    color: var(--black);
  }
  .fs-input:focus { border-color: var(--accent); }

  .fs-results { margin-top: 3rem; max-height: 50vh; overflow-y: auto; }

  .fs-empty span { display: block; font-family: var(--sans); font-size: 0.8rem; text-transform: uppercase; color: #888; margin-bottom: 1rem; }
  .fs-tags { display: flex; gap: 0.8rem; flex-wrap: wrap; }
  .fs-tag {
    padding: 0.5rem 1.2rem; border: 1px solid #ddd; border-radius: 50px;
    text-decoration: none; color: var(--black); font-family: var(--sans);
    font-size: 0.85rem; transition: 0.2s;
  }
  .fs-tag:hover { background: var(--black); color: var(--white); border-color: var(--black); }

  .search-hit {
    display: flex; align-items: center; gap: 1.5rem;
    padding: 1rem 0; border-bottom: 1px solid #eee;
    text-decoration: none; color: var(--black);
    animation: slideUp 0.3s ease-out forwards;
  }
  .search-hit img { width: 80px; height: 80px; object-fit: cover; border-radius: 4px; }
  .search-hit h4 { font-family: var(--serif); font-size: 1.4rem; margin: 0; }
  .search-hit span { font-family: var(--sans); font-size: 0.75rem; color: var(--accent); text-transform: uppercase; font-weight: 700; }

  @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }


  /* --- MOBILE MENU --- */
  .mobile-menu {
    position: fixed; top: 120px; left: 0; width: 100%; height: calc(100vh - 120px);
    background: var(--white); z-index: 850;
    transform: translateY(20px); opacity: 0; pointer-events: none;
    transition: 0.3s ease; padding: 2rem;
  }
  .mobile-menu.open { transform: translateY(0); opacity: 1; pointer-events: all; }

  .mm-nav { display: flex; flex-direction: column; gap: 1.5rem; text-align: center; }
  .mm-link {
    font-family: var(--serif); font-size: 2rem; color: var(--black);
    text-decoration: none; font-weight: 700;
  }
  .mm-cats { display: flex; flex-wrap: wrap; justify-content: center; gap: 0.5rem; margin-top: 2rem; }
  .mm-cat {
    font-family: var(--sans); font-size: 0.8rem; color: #666;
    background: #f4f4f4; padding: 0.5rem 1rem; border-radius: 4px; text-decoration: none;
  }

</style>

<script is:inline define:vars={{posts: serializedPosts}}>
  const menuTrigger = document.getElementById('menu-trigger');
  const mobileMenu = document.getElementById('mobile-menu');
  const stickyNav = document.getElementById('sticky-nav');
  const searchTrigger = document.getElementById('search-trigger');
  const fsSearch = document.getElementById('fs-search');
  const fsClose = document.getElementById('fs-close');
  const fsInput = document.getElementById('fs-input');
  const fsResults = document.getElementById('fs-results');
  const progressBar = document.getElementById('scroll-progress');

  // MENU
  let isMenuOpen = false;
  menuTrigger.addEventListener('click', () => {
    isMenuOpen = !isMenuOpen;
    mobileMenu.classList.toggle('open');
    menuTrigger.classList.toggle('menu-active');
    document.body.style.overflow = isMenuOpen ? 'hidden' : '';
  });

  // SEARCH
  searchTrigger.addEventListener('click', () => {
    fsSearch.classList.add('active');
    setTimeout(() => fsInput.focus(), 100);
    document.body.style.overflow = 'hidden';
  });

  fsClose.addEventListener('click', () => {
    fsSearch.classList.remove('active');
    document.body.style.overflow = '';
  });

  // SEARCH LOGIC
  fsInput.addEventListener('input', (e) => {
    const term = e.target.value.toLowerCase().trim();
    if(term.length < 2) {
       fsResults.innerHTML = `
        <div class="fs-empty">
          <span>Trending now:</span>
          <div class="fs-tags">
             <a href="/category/politics" class="fs-tag">Politics</a>
             <a href="/category/business" class="fs-tag">Business</a>
             <a href="/category/sports" class="fs-tag">Sports</a>
          </div>
        </div>`;
       return;
    }

    const hits = posts.filter(p => p.title.toLowerCase().includes(term)).slice(0, 5);

    if(hits.length === 0) {
      fsResults.innerHTML = `<div style="text-align:center; color:#999; margin-top:2rem;">No stories found for "${term}"</div>`;
    } else {
      fsResults.innerHTML = hits.map(h => `
        <a href="/posts/${h.slug}" class="search-hit">
           <img src="${h.image}" alt="">
           <div>
              <span>${h.category}</span>
              <h4>${h.title}</h4>
           </div>
        </a>
      `).join('');
    }
  });

  // SCROLL & STICKY
  let lastScroll = 0;
  window.addEventListener('scroll', () => {
    const currentScroll = window.scrollY;

    const totalHeight = document.documentElement.scrollHeight - window.innerHeight;
    const progress = (currentScroll / totalHeight) * 100;
    if(progressBar) progressBar.style.width = `${progress}%`;

    if (currentScroll > 100 && currentScroll > lastScroll && !isMenuOpen) {
      stickyNav.classList.add('nav-up');
    } else {
      stickyNav.classList.remove('nav-up');
    }
    lastScroll = currentScroll;
  });

  document.addEventListener('keydown', (e) => {
    if(e.key === 'Escape') {
      fsSearch.classList.remove('active');
      if(isMenuOpen) menuTrigger.click();
    }
  });
</script>