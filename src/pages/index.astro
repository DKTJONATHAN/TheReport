---
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';

// 1. DATA LOGIC
const allPosts = (await getCollection('posts'))
  .filter(p => !p.data.draft)
  .sort((a, b) => new Date(b.data.date).valueOf() - new Date(a.data.date).valueOf());

if (allPosts.length === 0) {
  throw new Error("No posts found! Add at least one post to build the homepage.");
}

const majorCategories = ['Politics', 'Business', 'Sports', 'Lifestyle', 'Technology'];

// Logic for "Live" ring (Less than 6 hours old)
const isLive = (date) => (new Date() - new Date(date)) < 6 * 60 * 60 * 1000;

// 2. STORY CIRCLES (Dynamic Pulse)
const combinedCircles = allPosts.slice(0, 10).map(post => ({
  label: post.data.category || 'News',
  image: post.data.image,
  link: `/posts/${post.slug}`,
  live: isLive(post.data.date)
}));

// 3. SECTIONS (Bento Logic)
const [heroMain, ...heroGrid] = allPosts.slice(0, 5);
const trendingPosts = allPosts.slice(5, 11);
const opinionPosts = allPosts.filter(p => p.data.category === 'Opinion').slice(0, 3);
---

<Layout title="Jonathan Mwaniki | Kenya News Hub" description="Breaking news, hard-hitting analysis, and global insights.">

  <div class="page-wrapper">
    
    {/* --- 1. THE PULSE BAR (Recency Focus) --- */}
    <section class="pulse-section">
      <div class="main-container">
        <div class="pulse-scroll">
          {combinedCircles.map(item => (
            <a href={item.link} class="pulse-item">
              <div class={`pulse-ring ${item.live ? 'is-live' : ''}`}>
                <img src={item.image} alt={item.label} loading="eager" />
                {item.live && <span class="live-dot">LIVE</span>}
              </div>
              <span class="pulse-label">{item.label}</span>
            </a>
          ))}
        </div>
      </div>
    </section>

    <main class="main-container">
      
      {/* --- 2. BENTO HERO (Authority Logic) --- */}
      <section class="bento-hero">
        {/* Massive Featured Post */}
        <article class="bento-main glass-card">
          <a href={`/posts/${heroMain.slug}`}>
            <div class="bento-img-box">
              <img src={heroMain.data.image} alt={heroMain.data.title} loading="eager" />
              <div class="img-overlay"></div>
              <div class="bento-content">
                <span class="cat-pill">{heroMain.data.category}</span>
                <h1>{heroMain.data.title}</h1>
                <p>{heroMain.data.description}</p>
              </div>
            </div>
          </a>
        </article>

        {/* Small Grid Side */}
        <div class="bento-side">
          {heroGrid.map(post => (
            <a href={`/posts/${post.slug}`} class="bento-sub glass-card">
              <div class="sub-img">
                <img src={post.data.image} alt={post.data.title} loading="lazy" />
              </div>
              <div class="sub-info">
                 <span class="sub-cat">{post.data.category}</span>
                 <h3>{post.data.title}</h3>
              </div>
            </a>
          ))}
        </div>
      </section>

      {/* --- 3. THE FEED GRID --- */}
      <div class="layout-grid">
        
        {/* Main Feed */}
        <div class="feed-column">
          <div class="section-heading">
            <h2>The Latest Updates</h2>
            <div class="glow-line"></div>
          </div>

          <div class="news-stack">
            {trendingPosts.map(post => (
              <article class="news-card glass-card">
                <a href={`/posts/${post.slug}`}>
                  <div class="card-layout">
                    <div class="card-text">
                      <div class="card-meta">
                        <span class="meta-cat">{post.data.category}</span>
                        <span class="meta-date">{new Date(post.data.date).toLocaleDateString()}</span>
                      </div>
                      <h3>{post.data.title}</h3>
                      <p>{post.data.description}</p>
                    </div>
                    <div class="card-img">
                      <img src={post.data.image} alt={post.data.title} loading="lazy" />
                    </div>
                  </div>
                </a>
              </article>
            ))}
          </div>
        </div>

        {/* Sidebar */}
        <aside class="sidebar-column">
          <div class="sticky-rail">
            
            {/* Newsletter: Conversion Driven */}
            <div class="widget newsletter-widget glass-card">
              <h3>Get the Scoop</h3>
              <p>Sign up for Belinda's daily cynicism report.</p>
              <form class="news-form">
                <input type="email" placeholder="email@address.com" required />
                <button type="submit">Join the List</button>
              </form>
            </div>

            {/* Trending Topics List */}
            <div class="widget topics-widget glass-card">
              <h4 class="widget-head">Trending Topics</h4>
              <div class="topic-pills">
                {majorCategories.map(cat => (
                  <a href={`/category/${cat.toLowerCase()}`} class="pill">{cat}</a>
                ))}
              </div>
            </div>

          </div>
        </aside>

      </div>
    </main>
  </div>

  <style>
    /* --- THEMW VARIABLES --- */
    :root {
      --bg-dark: #0f172a;
      --card-bg: rgba(30, 41, 59, 0.7);
      --accent: #ef4444; /* Brighter Red for focus */
      --text-pri: #f8fafc;
      --text-sec: #94a3b8;
      --glass-border: rgba(255, 255, 255, 0.1);
      --font-display: 'Inter', system-ui, sans-serif;
      --font-body: 'Merriweather', Georgia, serif;
    }

    body { background: var(--bg-dark); color: var(--text-pri); font-family: var(--font-body); margin: 0; }
    img { width: 100%; height: 100%; object-fit: cover; }
    .main-container { max-width: 1240px; margin: 0 auto; padding: 0 1.5rem; }

    /* --- GLASS UI --- */
    .glass-card {
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .glass-card:hover { border-color: var(--accent); transform: translateY(-4px); }

    /* --- PULSE (Stories) --- */
    .pulse-section { padding: 1.5rem 0; border-bottom: 1px solid var(--glass-border); margin-bottom: 2rem; }
    .pulse-scroll { display: flex; gap: 1.5rem; overflow-x: auto; scrollbar-width: none; }
    .pulse-item { flex: 0 0 auto; width: 75px; text-align: center; cursor: pointer; }
    .pulse-ring { 
      width: 75px; height: 75px; border-radius: 50%; padding: 3px; border: 2px solid transparent; 
      position: relative; margin-bottom: 0.5rem; transition: transform 0.3s;
    }
    .pulse-ring img { border-radius: 50%; width: 100%; height: 100%; border: 2px solid var(--bg-dark); }
    .pulse-ring.is-live { border-color: var(--accent); box-shadow: 0 0 10px var(--accent); }
    .live-dot { 
      position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
      background: var(--accent); color: white; font-size: 0.6rem; font-weight: 900;
      padding: 1px 4px; border-radius: 4px; border: 1px solid var(--bg-dark);
    }
    .pulse-label { font-family: var(--font-display); font-size: 0.7rem; font-weight: 700; color: var(--text-sec); }

    /* --- BENTO HERO --- */
    .bento-hero { display: grid; gap: 1rem; margin-bottom: 3rem; }
    @media (min-width: 1024px) { .bento-hero { grid-template-columns: 2fr 1fr; height: 500px; } }

    .bento-main { position: relative; }
    .bento-img-box { position: relative; height: 100%; }
    .img-overlay { position: absolute; inset: 0; background: linear-gradient(to top, rgba(15,23,42,0.9), transparent); }
    .bento-content { position: absolute; bottom: 0; padding: 2rem; }
    .cat-pill { background: var(--accent); padding: 4px 10px; border-radius: 4px; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; margin-bottom: 1rem; display: inline-block; }
    .bento-content h1 { font-family: var(--font-display); font-size: clamp(1.5rem, 5vw, 2.8rem); line-height: 1.1; margin: 0.5rem 0; }
    
    .bento-side { display: grid; grid-template-rows: repeat(4, 1fr); gap: 0.8rem; }
    .bento-sub { display: flex; gap: 1rem; padding: 0.5rem; }
    .sub-img { width: 80px; height: 60px; flex-shrink: 0; border-radius: 6px; overflow: hidden; }
    .sub-info h3 { font-family: var(--font-display); font-size: 0.95rem; margin: 0; line-height: 1.3; color: var(--text-pri); }
    .sub-cat { font-size: 0.65rem; color: var(--accent); font-weight: 800; text-transform: uppercase; }

    /* --- GRID LAYOUT --- */
    @media (min-width: 1024px) {
      .layout-grid { display: grid; grid-template-columns: 1fr 340px; gap: 3rem; }
    }

    .section-heading { display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem; }
    .section-heading h2 { font-family: var(--font-display); font-size: 1.4rem; white-space: nowrap; }
    .glow-line { flex: 1; height: 1px; background: linear-gradient(90deg, var(--accent), transparent); }

    .news-stack { display: flex; flex-direction: column; gap: 1.5rem; }
    .news-card { padding: 1.5rem; }
    .card-layout { display: flex; flex-direction: column-reverse; gap: 1rem; }
    @media (min-width: 640px) { .card-layout { flex-direction: row; align-items: flex-start; } }

    .card-text { flex: 1; }
    .card-meta { font-family: var(--font-display); font-size: 0.75rem; font-weight: 700; color: var(--text-sec); margin-bottom: 0.5rem; }
    .meta-cat { color: var(--accent); margin-right: 1rem; }
    .card-text h3 { font-family: var(--font-display); font-size: 1.5rem; margin: 0.5rem 0; line-height: 1.2; }
    .card-text p { font-size: 0.95rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .card-img { width: 100%; height: 200px; border-radius: 8px; overflow: hidden; }
    @media (min-width: 640px) { .card-img { width: 220px; height: 140px; } }

    /* --- SIDEBAR --- */
    .sticky-rail { position: sticky; top: 2rem; display: flex; flex-direction: column; gap: 2rem; }
    .widget { padding: 1.5rem; }
    .widget h3 { font-family: var(--font-display); margin-top: 0; }
    .news-form { display: flex; flex-direction: column; gap: 0.8rem; margin-top: 1rem; }
    .news-form input { background: var(--bg-dark); border: 1px solid var(--glass-border); padding: 12px; border-radius: 6px; color: white; font-family: var(--font-display); }
    .news-form button { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 6px; font-weight: 800; cursor: pointer; text-transform: uppercase; }

    .topic-pills { display: flex; flex-wrap: wrap; gap: 0.5rem; }
    .pill { background: var(--bg-dark); border: 1px solid var(--glass-border); padding: 6px 14px; border-radius: 20px; font-size: 0.75rem; font-family: var(--font-display); font-weight: 600; }
    .pill:hover { background: var(--accent); border-color: var(--accent); }
  </style>
</Layout>